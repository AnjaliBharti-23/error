# error
04-07-2024 :-
"C:\Program Files\Amazon Corretto\jdk21.0.0_35\bin\java.exe" -ea -Didea.test.cyclic.buffer.size=1048576 "-javaagent:C:\Program Files\JetBrains\IntelliJ IDEA Community Edition 2023.3.3\lib\idea_rt.jar=53795:C:\Program Files\JetBrains\IntelliJ IDEA Community Edition 2023.3.3\bin" -Dfile.encoding=UTF-8 -Dsun.stdout.encoding=UTF-8 -Dsun.stderr.encoding=UTF-8 -classpath "C:\Users\2134287\.m2\repository\org\junit\platform\junit-platform-launcher\1.10.2\junit-platform-launcher-1.10.2.jar;C:\Users\2134287\.m2\repository\org\junit\vintage\junit-vintage-engine\5.10.2\junit-vintage-engine-5.10.2.jar;C:\Program Files\JetBrains\IntelliJ IDEA Community Edition 2023.3.3\lib\idea_rt.jar;C:\Program Files\JetBrains\IntelliJ IDEA Community Edition 2023.3.3\plugins\junit\lib\junit5-rt.jar;C:\Program Files\JetBrains\IntelliJ IDEA Community Edition 2023.3.3\plugins\junit\lib\junit-rt.jar;C:\Anjali_Bharti_007\10-HMT\3-HMT\hmt-offer-eligibility-service\target\test-classes;C:\Anjali_Bharti_007\10-HMT\3-HMT\hmt-offer-eligibility-service\target\classes;C:\Users\2134287\.m2\repository\org\springframework\boot\spring-boot-starter-web\3.3.0\spring-boot-starter-web-3.3.0.jar;C:\Users\2134287\.m2\repository\org\springframework\boot\spring-boot-starter\3.3.0\spring-boot-starter-3.3.0.jar;C:\Users\2134287\.m2\repository\org\springframework\boot\spring-boot-starter-logging\3.3.0\spring-boot-starter-logging-3.3.0.jar;C:\Users\2134287\.m2\repository\ch\qos\logback\logback-classic\1.5.6\logback-classic-1.5.6.jar;C:\Users\2134287\.m2\repository\ch\qos\logback\logback-core\1.5.6\logback-core-1.5.6.jar;C:\Users\2134287\.m2\repository\org\apache\logging\log4j\log4j-to-slf4j\2.23.1\log4j-to-slf4j-2.23.1.jar;C:\Users\2134287\.m2\repository\org\apache\logging\log4j\log4j-api\2.23.1\log4j-api-2.23.1.jar;C:\Users\2134287\.m2\repository\org\slf4j\jul-to-slf4j\2.0.13\jul-to-slf4j-2.0.13.jar;C:\Users\2134287\.m2\repository\jakarta\annotation\jakarta.annotation-api\2.1.1\jakarta.annotation-api-2.1.1.jar;C:\Users\2134287\.m2\repository\org\yaml\snakeyaml\2.2\snakeyaml-2.2.jar;C:\Users\2134287\.m2\repository\org\springframework\boot\spring-boot-starter-json\3.3.0\spring-boot-starter-json-3.3.0.jar;C:\Users\2134287\.m2\repository\com\fasterxml\jackson\datatype\jackson-datatype-jdk8\2.17.1\jackson-datatype-jdk8-2.17.1.jar;C:\Users\2134287\.m2\repository\com\fasterxml\jackson\datatype\jackson-datatype-jsr310\2.17.1\jackson-datatype-jsr310-2.17.1.jar;C:\Users\2134287\.m2\repository\com\fasterxml\jackson\module\jackson-module-parameter-names\2.17.1\jackson-module-parameter-names-2.17.1.jar;C:\Users\2134287\.m2\repository\org\springframework\boot\spring-boot-starter-tomcat\3.3.0\spring-boot-starter-tomcat-3.3.0.jar;C:\Users\2134287\.m2\repository\org\apache\tomcat\embed\tomcat-embed-core\10.1.24\tomcat-embed-core-10.1.24.jar;C:\Users\2134287\.m2\repository\org\apache\tomcat\embed\tomcat-embed-el\10.1.24\tomcat-embed-el-10.1.24.jar;C:\Users\2134287\.m2\repository\org\apache\tomcat\embed\tomcat-embed-websocket\10.1.24\tomcat-embed-websocket-10.1.24.jar;C:\Users\2134287\.m2\repository\org\springframework\spring-web\6.1.8\spring-web-6.1.8.jar;C:\Users\2134287\.m2\repository\org\springframework\spring-beans\6.1.8\spring-beans-6.1.8.jar;C:\Users\2134287\.m2\repository\org\springframework\spring-webmvc\6.1.8\spring-webmvc-6.1.8.jar;C:\Users\2134287\.m2\repository\org\springframework\spring-aop\6.1.8\spring-aop-6.1.8.jar;C:\Users\2134287\.m2\repository\org\springframework\spring-context\6.1.8\spring-context-6.1.8.jar;C:\Users\2134287\.m2\repository\org\springframework\spring-expression\6.1.8\spring-expression-6.1.8.jar;C:\Users\2134287\.m2\repository\org\springframework\boot\spring-boot-starter-oauth2-resource-server\3.3.0\spring-boot-starter-oauth2-resource-server-3.3.0.jar;C:\Users\2134287\.m2\repository\org\springframework\security\spring-security-config\6.3.0\spring-security-config-6.3.0.jar;C:\Users\2134287\.m2\repository\org\springframework\security\spring-security-core\6.3.0\spring-security-core-6.3.0.jar;C:\Users\2134287\.m2\repository\org\springframework\security\spring-security-crypto\6.3.0\spring-security-crypto-6.3.0.jar;C:\Users\2134287\.m2\repository\org\springframework\security\spring-security-oauth2-resource-server\6.3.0\spring-security-oauth2-resource-server-6.3.0.jar;C:\Users\2134287\.m2\repository\org\springframework\security\spring-security-oauth2-core\6.3.0\spring-security-oauth2-core-6.3.0.jar;C:\Users\2134287\.m2\repository\org\springframework\security\spring-security-oauth2-jose\6.3.0\spring-security-oauth2-jose-6.3.0.jar;C:\Users\2134287\.m2\repository\com\nimbusds\nimbus-jose-jwt\9.37.3\nimbus-jose-jwt-9.37.3.jar;C:\Users\2134287\.m2\repository\com\github\stephenc\jcip\jcip-annotations\1.0-1\jcip-annotations-1.0-1.jar;C:\Users\2134287\.m2\repository\org\springframework\boot\spring-boot-starter-data-jpa\3.3.0\spring-boot-starter-data-jpa-3.3.0.jar;C:\Users\2134287\.m2\repository\org\springframework\boot\spring-boot-starter-aop\3.3.0\spring-boot-starter-aop-3.3.0.jar;C:\Users\2134287\.m2\repository\org\aspectj\aspectjweaver\1.9.22\aspectjweaver-1.9.22.jar;C:\Users\2134287\.m2\repository\org\springframework\boot\spring-boot-starter-jdbc\3.3.0\spring-boot-starter-jdbc-3.3.0.jar;C:\Users\2134287\.m2\repository\com\zaxxer\HikariCP\5.1.0\HikariCP-5.1.0.jar;C:\Users\2134287\.m2\repository\org\springframework\spring-jdbc\6.1.8\spring-jdbc-6.1.8.jar;C:\Users\2134287\.m2\repository\org\hibernate\orm\hibernate-core\6.5.2.Final\hibernate-core-6.5.2.Final.jar;C:\Users\2134287\.m2\repository\jakarta\persistence\jakarta.persistence-api\3.1.0\jakarta.persistence-api-3.1.0.jar;C:\Users\2134287\.m2\repository\jakarta\transaction\jakarta.transaction-api\2.0.1\jakarta.transaction-api-2.0.1.jar;C:\Users\2134287\.m2\repository\org\jboss\logging\jboss-logging\3.5.3.Final\jboss-logging-3.5.3.Final.jar;C:\Users\2134287\.m2\repository\org\hibernate\common\hibernate-commons-annotations\6.0.6.Final\hibernate-commons-annotations-6.0.6.Final.jar;C:\Users\2134287\.m2\repository\io\smallrye\jandex\3.1.2\jandex-3.1.2.jar;C:\Users\2134287\.m2\repository\com\fasterxml\classmate\1.7.0\classmate-1.7.0.jar;C:\Users\2134287\.m2\repository\net\bytebuddy\byte-buddy\1.14.16\byte-buddy-1.14.16.jar;C:\Users\2134287\.m2\repository\jakarta\inject\jakarta.inject-api\2.0.1\jakarta.inject-api-2.0.1.jar;C:\Users\2134287\.m2\repository\org\antlr\antlr4-runtime\4.13.0\antlr4-runtime-4.13.0.jar;C:\Users\2134287\.m2\repository\org\springframework\data\spring-data-jpa\3.3.0\spring-data-jpa-3.3.0.jar;C:\Users\2134287\.m2\repository\org\springframework\data\spring-data-commons\3.3.0\spring-data-commons-3.3.0.jar;C:\Users\2134287\.m2\repository\org\springframework\spring-orm\6.1.8\spring-orm-6.1.8.jar;C:\Users\2134287\.m2\repository\org\springframework\spring-tx\6.1.8\spring-tx-6.1.8.jar;C:\Users\2134287\.m2\repository\org\springframework\spring-aspects\6.1.8\spring-aspects-6.1.8.jar;C:\Users\2134287\.m2\repository\com\oracle\database\jdbc\ojdbc11\21.9.0.0\ojdbc11-21.9.0.0.jar;C:\Users\2134287\.m2\repository\org\springframework\boot\spring-boot-starter-cache\3.3.0\spring-boot-starter-cache-3.3.0.jar;C:\Users\2134287\.m2\repository\org\springframework\spring-context-support\6.1.8\spring-context-support-6.1.8.jar;C:\Users\2134287\.m2\repository\org\ehcache\ehcache\3.10.8\ehcache-3.10.8.jar;C:\Users\2134287\.m2\repository\javax\cache\cache-api\1.1.1\cache-api-1.1.1.jar;C:\Users\2134287\.m2\repository\org\slf4j\slf4j-api\2.0.13\slf4j-api-2.0.13.jar;C:\Users\2134287\.m2\repository\org\glassfish\jaxb\jaxb-runtime\4.0.5\jaxb-runtime-4.0.5.jar;C:\Users\2134287\.m2\repository\org\glassfish\jaxb\jaxb-core\4.0.5\jaxb-core-4.0.5.jar;C:\Users\2134287\.m2\repository\org\eclipse\angus\angus-activation\2.0.2\angus-activation-2.0.2.jar;C:\Users\2134287\.m2\repository\org\glassfish\jaxb\txw2\4.0.5\txw2-4.0.5.jar;C:\Users\2134287\.m2\repository\com\sun\istack\istack-commons-runtime\4.1.2\istack-commons-runtime-4.1.2.jar;C:\Users\2134287\.m2\repository\org\apache\kafka\kafka-streams\3.7.0\kafka-streams-3.7.0.jar;C:\Users\2134287\.m2\repository\org\apache\kafka\kafka-clients\3.7.0\kafka-clients-3.7.0.jar;C:\Users\2134287\.m2\repository\com\github\luben\zstd-jni\1.5.5-6\zstd-jni-1.5.5-6.jar;C:\Users\2134287\.m2\repository\org\lz4\lz4-java\1.8.0\lz4-java-1.8.0.jar;C:\Users\2134287\.m2\repository\org\xerial\snappy\snappy-java\1.1.10.5\snappy-java-1.1.10.5.jar;C:\Users\2134287\.m2\repository\org\rocksdb\rocksdbjni\7.9.2\rocksdbjni-7.9.2.jar;C:\Users\2134287\.m2\repository\com\fasterxml\jackson\core\jackson-annotations\2.17.1\jackson-annotations-2.17.1.jar;C:\Users\2134287\.m2\repository\com\fasterxml\jackson\core\jackson-databind\2.17.1\jackson-databind-2.17.1.jar;C:\Users\2134287\.m2\repository\com\fasterxml\jackson\core\jackson-core\2.17.1\jackson-core-2.17.1.jar;C:\Users\2134287\.m2\repository\org\springframework\cloud\spring-cloud-stream-binder-kafka-streams\4.1.1\spring-cloud-stream-binder-kafka-streams-4.1.1.jar;C:\Users\2134287\.m2\repository\org\springframework\cloud\spring-cloud-stream-binder-kafka-core\4.1.1\spring-cloud-stream-binder-kafka-core-4.1.1.jar;C:\Users\2134287\.m2\repository\org\springframework\cloud\spring-cloud-stream\4.1.1\spring-cloud-stream-4.1.1.jar;C:\Users\2134287\.m2\repository\org\springframework\boot\spring-boot-starter-validation\3.3.0\spring-boot-starter-validation-3.3.0.jar;C:\Users\2134287\.m2\repository\org\hibernate\validator\hibernate-validator\8.0.1.Final\hibernate-validator-8.0.1.Final.jar;C:\Users\2134287\.m2\repository\org\springframework\integration\spring-integration-jmx\6.3.0\spring-integration-jmx-6.3.0.jar;C:\Users\2134287\.m2\repository\org\springframework\cloud\spring-cloud-function-context\4.1.1\spring-cloud-function-context-4.1.1.jar;C:\Users\2134287\.m2\repository\net\jodah\typetools\0.6.2\typetools-0.6.2.jar;C:\Users\2134287\.m2\repository\org\springframework\cloud\spring-cloud-function-core\4.1.1\spring-cloud-function-core-4.1.1.jar;C:\Users\2134287\.m2\repository\org\jetbrains\kotlin\kotlin-stdlib-jdk8\1.9.24\kotlin-stdlib-jdk8-1.9.24.jar;C:\Users\2134287\.m2\repository\org\jetbrains\kotlin\kotlin-stdlib\1.9.24\kotlin-stdlib-1.9.24.jar;C:\Users\2134287\.m2\repository\org\jetbrains\annotations\13.0\annotations-13.0.jar;C:\Users\2134287\.m2\repository\org\jetbrains\kotlin\kotlin-stdlib-jdk7\1.9.24\kotlin-stdlib-jdk7-1.9.24.jar;C:\Users\2134287\.m2\repository\org\springframework\kafka\spring-kafka\3.2.0\spring-kafka-3.2.0.jar;C:\Users\2134287\.m2\repository\org\springframework\spring-messaging\6.1.8\spring-messaging-6.1.8.jar;C:\Users\2134287\.m2\repository\org\springframework\retry\spring-retry\2.0.6\spring-retry-2.0.6.jar;C:\Users\2134287\.m2\repository\org\springframework\integration\spring-integration-kafka\6.3.0\spring-integration-kafka-6.3.0.jar;C:\Users\2134287\.m2\repository\org\springframework\integration\spring-integration-core\6.3.0\spring-integration-core-6.3.0.jar;C:\Users\2134287\.m2\repository\io\projectreactor\reactor-core\3.6.6\reactor-core-3.6.6.jar;C:\Users\2134287\.m2\repository\org\reactivestreams\reactive-streams\1.0.4\reactive-streams-1.0.4.jar;C:\Users\2134287\.m2\repository\org\springframework\boot\spring-boot-starter-test\3.3.0\spring-boot-starter-test-3.3.0.jar;C:\Users\2134287\.m2\repository\org\springframework\boot\spring-boot-test\3.3.0\spring-boot-test-3.3.0.jar;C:\Users\2134287\.m2\repository\org\springframework\boot\spring-boot-test-autoconfigure\3.3.0\spring-boot-test-autoconfigure-3.3.0.jar;C:\Users\2134287\.m2\repository\com\jayway\jsonpath\json-path\2.9.0\json-path-2.9.0.jar;C:\Users\2134287\.m2\repository\jakarta\xml\bind\jakarta.xml.bind-api\4.0.2\jakarta.xml.bind-api-4.0.2.jar;C:\Users\2134287\.m2\repository\jakarta\activation\jakarta.activation-api\2.1.3\jakarta.activation-api-2.1.3.jar;C:\Users\2134287\.m2\repository\net\minidev\json-smart\2.5.1\json-smart-2.5.1.jar;C:\Users\2134287\.m2\repository\net\minidev\accessors-smart\2.5.1\accessors-smart-2.5.1.jar;C:\Users\2134287\.m2\repository\org\ow2\asm\asm\9.6\asm-9.6.jar;C:\Users\2134287\.m2\repository\org\assertj\assertj-core\3.25.3\assertj-core-3.25.3.jar;C:\Users\2134287\.m2\repository\org\awaitility\awaitility\4.2.1\awaitility-4.2.1.jar;C:\Users\2134287\.m2\repository\org\hamcrest\hamcrest\2.2\hamcrest-2.2.jar;C:\Users\2134287\.m2\repository\org\junit\jupiter\junit-jupiter\5.10.2\junit-jupiter-5.10.2.jar;C:\Users\2134287\.m2\repository\org\junit\jupiter\junit-jupiter-api\5.10.2\junit-jupiter-api-5.10.2.jar;C:\Users\2134287\.m2\repository\org\opentest4j\opentest4j\1.3.0\opentest4j-1.3.0.jar;C:\Users\2134287\.m2\repository\org\junit\platform\junit-platform-commons\1.10.2\junit-platform-commons-1.10.2.jar;C:\Users\2134287\.m2\repository\org\apiguardian\apiguardian-api\1.1.2\apiguardian-api-1.1.2.jar;C:\Users\2134287\.m2\repository\org\junit\jupiter\junit-jupiter-params\5.10.2\junit-jupiter-params-5.10.2.jar;C:\Users\2134287\.m2\repository\org\junit\jupiter\junit-jupiter-engine\5.10.2\junit-jupiter-engine-5.10.2.jar;C:\Users\2134287\.m2\repository\org\junit\platform\junit-platform-engine\1.10.2\junit-platform-engine-1.10.2.jar;C:\Users\2134287\.m2\repository\org\mockito\mockito-core\5.11.0\mockito-core-5.11.0.jar;C:\Users\2134287\.m2\repository\net\bytebuddy\byte-buddy-agent\1.14.16\byte-buddy-agent-1.14.16.jar;C:\Users\2134287\.m2\repository\org\objenesis\objenesis\3.3\objenesis-3.3.jar;C:\Users\2134287\.m2\repository\org\mockito\mockito-junit-jupiter\5.11.0\mockito-junit-jupiter-5.11.0.jar;C:\Users\2134287\.m2\repository\org\skyscreamer\jsonassert\1.5.1\jsonassert-1.5.1.jar;C:\Users\2134287\.m2\repository\com\vaadin\external\google\android-json\0.0.20131108.vaadin1\android-json-0.0.20131108.vaadin1.jar;C:\Users\2134287\.m2\repository\org\springframework\spring-core\6.1.8\spring-core-6.1.8.jar;C:\Users\2134287\.m2\repository\org\springframework\spring-jcl\6.1.8\spring-jcl-6.1.8.jar;C:\Users\2134287\.m2\repository\org\springframework\spring-test\6.1.8\spring-test-6.1.8.jar;C:\Users\2134287\.m2\repository\org\xmlunit\xmlunit-core\2.9.1\xmlunit-core-2.9.1.jar;C:\Users\2134287\.m2\repository\org\springframework\security\spring-security-test\6.3.0\spring-security-test-6.3.0.jar;C:\Users\2134287\.m2\repository\org\springframework\security\spring-security-web\6.3.0\spring-security-web-6.3.0.jar;C:\Users\2134287\.m2\repository\junit\junit\4.13.2\junit-4.13.2.jar;C:\Users\2134287\.m2\repository\org\hamcrest\hamcrest-core\2.2\hamcrest-core-2.2.jar;C:\Users\2134287\.m2\repository\org\springframework\boot\spring-boot-starter-actuator\3.3.0\spring-boot-starter-actuator-3.3.0.jar;C:\Users\2134287\.m2\repository\org\springframework\boot\spring-boot-actuator-autoconfigure\3.3.0\spring-boot-actuator-autoconfigure-3.3.0.jar;C:\Users\2134287\.m2\repository\org\springframework\boot\spring-boot-actuator\3.3.0\spring-boot-actuator-3.3.0.jar;C:\Users\2134287\.m2\repository\io\micrometer\micrometer-observation\1.13.0\micrometer-observation-1.13.0.jar;C:\Users\2134287\.m2\repository\io\micrometer\micrometer-commons\1.13.0\micrometer-commons-1.13.0.jar;C:\Users\2134287\.m2\repository\io\micrometer\micrometer-jakarta9\1.13.0\micrometer-jakarta9-1.13.0.jar;C:\Users\2134287\.m2\repository\io\micrometer\micrometer-core\1.13.0\micrometer-core-1.13.0.jar;C:\Users\2134287\.m2\repository\org\hdrhistogram\HdrHistogram\2.2.1\HdrHistogram-2.2.1.jar;C:\Users\2134287\.m2\repository\org\latencyutils\LatencyUtils\2.0.3\LatencyUtils-2.0.3.jar;C:\Users\2134287\.m2\repository\org\springframework\boot\spring-boot-devtools\3.3.0\spring-boot-devtools-3.3.0.jar;C:\Users\2134287\.m2\repository\org\springframework\boot\spring-boot\3.3.0\spring-boot-3.3.0.jar;C:\Users\2134287\.m2\repository\org\springframework\boot\spring-boot-autoconfigure\3.3.0\spring-boot-autoconfigure-3.3.0.jar;C:\Users\2134287\.m2\repository\org\projectlombok\lombok\1.18.32\lombok-1.18.32.jar;C:\Users\2134287\.m2\repository\org\springdoc\springdoc-openapi-starter-webmvc-ui\2.5.0\springdoc-openapi-starter-webmvc-ui-2.5.0.jar;C:\Users\2134287\.m2\repository\org\springdoc\springdoc-openapi-starter-webmvc-api\2.5.0\springdoc-openapi-starter-webmvc-api-2.5.0.jar;C:\Users\2134287\.m2\repository\org\springdoc\springdoc-openapi-starter-common\2.5.0\springdoc-openapi-starter-common-2.5.0.jar;C:\Users\2134287\.m2\repository\io\swagger\core\v3\swagger-core-jakarta\2.2.21\swagger-core-jakarta-2.2.21.jar;C:\Users\2134287\.m2\repository\org\apache\commons\commons-lang3\3.14.0\commons-lang3-3.14.0.jar;C:\Users\2134287\.m2\repository\io\swagger\core\v3\swagger-annotations-jakarta\2.2.21\swagger-annotations-jakarta-2.2.21.jar;C:\Users\2134287\.m2\repository\io\swagger\core\v3\swagger-models-jakarta\2.2.21\swagger-models-jakarta-2.2.21.jar;C:\Users\2134287\.m2\repository\jakarta\validation\jakarta.validation-api\3.0.2\jakarta.validation-api-3.0.2.jar;C:\Users\2134287\.m2\repository\com\fasterxml\jackson\dataformat\jackson-dataformat-yaml\2.17.1\jackson-dataformat-yaml-2.17.1.jar;C:\Users\2134287\.m2\repository\org\webjars\swagger-ui\5.13.0\swagger-ui-5.13.0.jar" com.intellij.rt.junit.JUnitStarter -ideVersion5 -junit5 com.aa.hmtautomation.offer.service.impl.OfferServiceImplTest
WARNING: A Java agent has been loaded dynamically (C:\Users\2134287\.m2\repository\net\bytebuddy\byte-buddy-agent\1.14.16\byte-buddy-agent-1.14.16.jar)
WARNING: If a serviceability tool is in use, please run with -XX:+EnableDynamicAgentLoading to hide this warning
WARNING: If a serviceability tool is not in use, please run with -Djdk.instrument.traceUsage for more information
WARNING: Dynamic loading of agents will be disallowed by default in a future release
OpenJDK 64-Bit Server VM warning: Sharing is only supported for boot loader classes because bootstrap classpath has been appended
02:42:59.166 [main] INFO com.aa.hmtautomation.offer.service.impl.OfferServiceImpl -- TransactionId: null ClassName: OfferServiceImpl method: offerMasterEntry hmtAutomationPnr: com.aa.hmtautomation.eligibility.model.HMTAutomationPnr@3451f01d[flightKey=com.aa.hmtautomation.eligibility.model.FlightKey@3252747e[fltNum=<null>,fltOrgDate=<null>,depSta=DFW,schDepDateTime=<null>,disruptDepDateTime=<null>],currentSegment=com.aa.hmtautomation.eligibility.model.CurrentSegment@2b4b96a4[oprCd=AA,oprFltNbr=2233,mktCode=AA,mktFltNbr=4455,status=<null>,seqNbr=<null>,arrStation=<null>,depDate=20240326,depTime=2359],offer=<null>,paxList=[],isAPass=<null>,recLoc=<null>,transactionId=<null>,portOfAccomodation=<null>,originStation=<null>,destinationStation=<null>,version=10,currencyCode=<null>,mealAmount=<null>,flifoCode=<null>,dsrtFltStatus=<null>]
02:42:59.458 [main] INFO com.aa.hmtautomation.offer.service.impl.OfferServiceImpl -- TransactionId: 444455555666 ClassName: OfferServiceImpl method: getPaxStatus isNonRev: true isStandBy: null
02:42:59.590 [main] INFO com.aa.hmtautomation.offer.service.impl.OfferServiceImpl -- TransactionId: test-123456 ClassName: OfferServiceImpl method: processMealIssuance hmtAutomationPnr: com.aa.hmtautomation.eligibility.model.HMTAutomationPnr@4887de2b[flightKey=com.aa.hmtautomation.eligibility.model.FlightKey@759de304[fltNum=<null>,fltOrgDate=<null>,depSta=DFW,schDepDateTime=<null>,disruptDepDateTime=<null>],currentSegment=com.aa.hmtautomation.eligibility.model.CurrentSegment@5649d11a[oprCd=AA,oprFltNbr=2233,mktCode=AA,mktFltNbr=4455,status=<null>,seqNbr=<null>,arrStation=<null>,depDate=20240326,depTime=2359],offer=<null>,paxList=[com.aa.hmtautomation.eligibility.model.Pax@294f9d50[seqNbr=1,firstName=<null>,lastName=<null>,classOfService=<null>,tierStatus=<null>,isWheelChair=<null>,isUM=<null>,isMinor=true,isEC261=true,isNonRev=<null>,isStandBy=<null>,hasPet=<null>,hasServicePet=<null>,isSpecialNeed=<null>,cupId=<null>,advantageNumber=<null>,isElite=true,credt=1710565200000,sSRcodes=[]]],isAPass=true,recLoc=<null>,transactionId=test-123456,portOfAccomodation=<null>,originStation=<null>,destinationStation=<null>,version=10,currencyCode=<null>,mealAmount=20,flifoCode=LMT-LATE ARRV A/C DUE TO PRIOR MAINTENANCE DELAYS-E,dsrtFltStatus=<null>]
02:42:59.593 [main] INFO com.aa.hmtautomation.offer.service.impl.OfferServiceImpl -- TransactionId: test-123456 ClassName: OfferServiceImpl method: acquireLock pnrLockEntity: PNRLockEntity(recloc=null, status=null, lockedTime=null, lastUpdatedTime=null, pnrVersion=null)
02:42:59.619 [main] INFO com.aa.hmtautomation.offer.service.impl.OfferServiceImpl -- TransactionId: test-123456 ClassName: OfferServiceImpl method: mealIssuanceEntry hmtAutomationPnr: com.aa.hmtautomation.eligibility.model.HMTAutomationPnr@4887de2b[flightKey=com.aa.hmtautomation.eligibility.model.FlightKey@759de304[fltNum=<null>,fltOrgDate=<null>,depSta=DFW,schDepDateTime=<null>,disruptDepDateTime=<null>],currentSegment=com.aa.hmtautomation.eligibility.model.CurrentSegment@5649d11a[oprCd=AA,oprFltNbr=2233,mktCode=AA,mktFltNbr=4455,status=<null>,seqNbr=<null>,arrStation=<null>,depDate=20240326,depTime=2359],offer=<null>,paxList=[com.aa.hmtautomation.eligibility.model.Pax@294f9d50[seqNbr=1,firstName=<null>,lastName=<null>,classOfService=<null>,tierStatus=<null>,isWheelChair=<null>,isUM=<null>,isMinor=true,isEC261=true,isNonRev=<null>,isStandBy=<null>,hasPet=<null>,hasServicePet=<null>,isSpecialNeed=<null>,cupId=<null>,advantageNumber=<null>,isElite=true,credt=1710565200000,sSRcodes=[]]],isAPass=true,recLoc=<null>,transactionId=test-123456,portOfAccomodation=<null>,originStation=<null>,destinationStation=<null>,version=10,currencyCode=<null>,mealAmount=20,flifoCode=LMT-LATE ARRV A/C DUE TO PRIOR MAINTENANCE DELAYS-E,dsrtFltStatus=<null>]
02:42:59.620 [main] INFO com.aa.hmtautomation.offer.service.impl.OfferServiceImpl -- TransactionId: test-123456 ClassName: OfferServiceImpl method: pnrEntry hmtAutomationPnr: com.aa.hmtautomation.eligibility.model.HMTAutomationPnr@4887de2b[flightKey=com.aa.hmtautomation.eligibility.model.FlightKey@759de304[fltNum=<null>,fltOrgDate=<null>,depSta=DFW,schDepDateTime=<null>,disruptDepDateTime=<null>],currentSegment=com.aa.hmtautomation.eligibility.model.CurrentSegment@5649d11a[oprCd=AA,oprFltNbr=2233,mktCode=AA,mktFltNbr=4455,status=<null>,seqNbr=<null>,arrStation=<null>,depDate=20240326,depTime=2359],offer=<null>,paxList=[com.aa.hmtautomation.eligibility.model.Pax@294f9d50[seqNbr=1,firstName=<null>,lastName=<null>,classOfService=<null>,tierStatus=<null>,isWheelChair=<null>,isUM=<null>,isMinor=true,isEC261=true,isNonRev=<null>,isStandBy=<null>,hasPet=<null>,hasServicePet=<null>,isSpecialNeed=<null>,cupId=<null>,advantageNumber=<null>,isElite=true,credt=1710565200000,sSRcodes=[]]],isAPass=true,recLoc=<null>,transactionId=test-123456,portOfAccomodation=<null>,originStation=<null>,destinationStation=<null>,version=10,currencyCode=<null>,mealAmount=20,flifoCode=LMT-LATE ARRV A/C DUE TO PRIOR MAINTENANCE DELAYS-E,dsrtFltStatus=<null>]
02:42:59.626 [main] INFO com.aa.hmtautomation.offer.service.impl.OfferServiceImpl -- TransactionId: test-123456 ClassName: OfferServiceImpl method: segmentEntry hmtAutomationPnr: com.aa.hmtautomation.eligibility.model.HMTAutomationPnr@4887de2b[flightKey=com.aa.hmtautomation.eligibility.model.FlightKey@759de304[fltNum=<null>,fltOrgDate=<null>,depSta=DFW,schDepDateTime=<null>,disruptDepDateTime=<null>],currentSegment=com.aa.hmtautomation.eligibility.model.CurrentSegment@5649d11a[oprCd=AA,oprFltNbr=2233,mktCode=AA,mktFltNbr=4455,status=<null>,seqNbr=<null>,arrStation=<null>,depDate=20240326,depTime=2359],offer=<null>,paxList=[com.aa.hmtautomation.eligibility.model.Pax@294f9d50[seqNbr=1,firstName=<null>,lastName=<null>,classOfService=<null>,tierStatus=<null>,isWheelChair=<null>,isUM=<null>,isMinor=true,isEC261=true,isNonRev=<null>,isStandBy=<null>,hasPet=<null>,hasServicePet=<null>,isSpecialNeed=<null>,cupId=<null>,advantageNumber=<null>,isElite=true,credt=1710565200000,sSRcodes=[]]],isAPass=true,recLoc=<null>,transactionId=test-123456,portOfAccomodation=<null>,originStation=<null>,destinationStation=<null>,version=10,currencyCode=<null>,mealAmount=20,flifoCode=LMT-LATE ARRV A/C DUE TO PRIOR MAINTENANCE DELAYS-E,dsrtFltStatus=<null>]
02:42:59.627 [main] INFO com.aa.hmtautomation.offer.service.impl.OfferServiceImpl -- TransactionId: test-123456 ClassName: OfferServiceImpl method: preparePnrSegEntity pnrSegKeyEntity: PnrSegKeyEntity(recloc=null, credt=2024-03-16 05:00:00.0, version=10, segSeqId=null)
02:42:59.651 [main] INFO com.aa.hmtautomation.offer.service.impl.OfferServiceImpl -- TransactionId: test-123456 ClassName: OfferServiceImpl method: paxEntry hmtAutomationPnr: com.aa.hmtautomation.eligibility.model.HMTAutomationPnr@4887de2b[flightKey=com.aa.hmtautomation.eligibility.model.FlightKey@759de304[fltNum=<null>,fltOrgDate=<null>,depSta=DFW,schDepDateTime=<null>,disruptDepDateTime=<null>],currentSegment=com.aa.hmtautomation.eligibility.model.CurrentSegment@5649d11a[oprCd=AA,oprFltNbr=2233,mktCode=AA,mktFltNbr=4455,status=<null>,seqNbr=<null>,arrStation=<null>,depDate=20240326,depTime=2359],offer=<null>,paxList=[com.aa.hmtautomation.eligibility.model.Pax@294f9d50[seqNbr=1,firstName=<null>,lastName=<null>,classOfService=<null>,tierStatus=<null>,isWheelChair=<null>,isUM=<null>,isMinor=true,isEC261=true,isNonRev=<null>,isStandBy=<null>,hasPet=<null>,hasServicePet=<null>,isSpecialNeed=<null>,cupId=<null>,advantageNumber=<null>,isElite=true,credt=1710565200000,sSRcodes=[]]],isAPass=true,recLoc=<null>,transactionId=test-123456,portOfAccomodation=<null>,originStation=<null>,destinationStation=<null>,version=10,currencyCode=<null>,mealAmount=20,flifoCode=LMT-LATE ARRV A/C DUE TO PRIOR MAINTENANCE DELAYS-E,dsrtFltStatus=<null>]
02:42:59.656 [main] INFO com.aa.hmtautomation.offer.service.impl.OfferServiceImpl -- TransactionId: test-123456 ClassName: OfferServiceImpl method: getPaxStatus isNonRev: null isStandBy: null
02:42:59.657 [main] INFO com.aa.hmtautomation.offer.service.impl.OfferServiceImpl -- TransactionId: test-123456 ClassName: OfferServiceImpl method: fqtvEntry hmtAutomationPnr: com.aa.hmtautomation.eligibility.model.HMTAutomationPnr@4887de2b[flightKey=com.aa.hmtautomation.eligibility.model.FlightKey@759de304[fltNum=<null>,fltOrgDate=<null>,depSta=DFW,schDepDateTime=<null>,disruptDepDateTime=<null>],currentSegment=com.aa.hmtautomation.eligibility.model.CurrentSegment@5649d11a[oprCd=AA,oprFltNbr=2233,mktCode=AA,mktFltNbr=4455,status=<null>,seqNbr=<null>,arrStation=<null>,depDate=20240326,depTime=2359],offer=<null>,paxList=[com.aa.hmtautomation.eligibility.model.Pax@294f9d50[seqNbr=1,firstName=<null>,lastName=<null>,classOfService=<null>,tierStatus=<null>,isWheelChair=<null>,isUM=<null>,isMinor=true,isEC261=true,isNonRev=<null>,isStandBy=<null>,hasPet=<null>,hasServicePet=<null>,isSpecialNeed=<null>,cupId=<null>,advantageNumber=<null>,isElite=true,credt=1710565200000,sSRcodes=[]]],isAPass=true,recLoc=<null>,transactionId=test-123456,portOfAccomodation=<null>,originStation=<null>,destinationStation=<null>,version=10,currencyCode=<null>,mealAmount=20,flifoCode=LMT-LATE ARRV A/C DUE TO PRIOR MAINTENANCE DELAYS-E,dsrtFltStatus=<null>]
02:42:59.658 [main] INFO com.aa.hmtautomation.offer.service.impl.OfferServiceImpl -- TransactionId: test-123456 ClassName: OfferServiceImpl method: getClassOfService classOfServiceCode: null
02:42:59.666 [main] INFO com.aa.hmtautomation.offer.service.impl.OfferServiceImpl -- TransactionId: test-123456 ClassName: OfferServiceImpl method: ssrEntry hmtAutomationPnr: com.aa.hmtautomation.eligibility.model.HMTAutomationPnr@4887de2b[flightKey=com.aa.hmtautomation.eligibility.model.FlightKey@759de304[fltNum=<null>,fltOrgDate=<null>,depSta=DFW,schDepDateTime=<null>,disruptDepDateTime=<null>],currentSegment=com.aa.hmtautomation.eligibility.model.CurrentSegment@5649d11a[oprCd=AA,oprFltNbr=2233,mktCode=AA,mktFltNbr=4455,status=<null>,seqNbr=<null>,arrStation=<null>,depDate=20240326,depTime=2359],offer=<null>,paxList=[com.aa.hmtautomation.eligibility.model.Pax@294f9d50[seqNbr=1,firstName=<null>,lastName=<null>,classOfService=<null>,tierStatus=<null>,isWheelChair=<null>,isUM=<null>,isMinor=true,isEC261=true,isNonRev=<null>,isStandBy=<null>,hasPet=<null>,hasServicePet=<null>,isSpecialNeed=<null>,cupId=<null>,advantageNumber=<null>,isElite=true,credt=1710565200000,sSRcodes=[]]],isAPass=true,recLoc=<null>,transactionId=test-123456,portOfAccomodation=<null>,originStation=<null>,destinationStation=<null>,version=10,currencyCode=<null>,mealAmount=20,flifoCode=LMT-LATE ARRV A/C DUE TO PRIOR MAINTENANCE DELAYS-E,dsrtFltStatus=<null>]
02:42:59.667 [main] INFO com.aa.hmtautomation.offer.service.impl.OfferServiceImpl -- TransactionId: test-123456 ClassName: OfferServiceImpl method: offerMasterEntry hmtAutomationPnr: com.aa.hmtautomation.eligibility.model.HMTAutomationPnr@4887de2b[flightKey=com.aa.hmtautomation.eligibility.model.FlightKey@759de304[fltNum=<null>,fltOrgDate=<null>,depSta=DFW,schDepDateTime=<null>,disruptDepDateTime=<null>],currentSegment=com.aa.hmtautomation.eligibility.model.CurrentSegment@5649d11a[oprCd=AA,oprFltNbr=2233,mktCode=AA,mktFltNbr=4455,status=<null>,seqNbr=<null>,arrStation=<null>,depDate=20240326,depTime=2359],offer=<null>,paxList=[com.aa.hmtautomation.eligibility.model.Pax@294f9d50[seqNbr=1,firstName=<null>,lastName=<null>,classOfService=<null>,tierStatus=<null>,isWheelChair=<null>,isUM=<null>,isMinor=true,isEC261=true,isNonRev=<null>,isStandBy=<null>,hasPet=<null>,hasServicePet=<null>,isSpecialNeed=<null>,cupId=<null>,advantageNumber=<null>,isElite=true,credt=1710565200000,sSRcodes=[]]],isAPass=true,recLoc=<null>,transactionId=test-123456,portOfAccomodation=<null>,originStation=<null>,destinationStation=<null>,version=10,currencyCode=<null>,mealAmount=20,flifoCode=LMT-LATE ARRV A/C DUE TO PRIOR MAINTENANCE DELAYS-E,dsrtFltStatus=<null>]
02:42:59.669 [main] INFO com.aa.hmtautomation.offer.service.impl.OfferServiceImpl -- TransactionId: test-123456 ClassName: OfferServiceImpl method: offerDetailsEntry hmtAutomationPnr: com.aa.hmtautomation.eligibility.model.HMTAutomationPnr@4887de2b[flightKey=com.aa.hmtautomation.eligibility.model.FlightKey@759de304[fltNum=<null>,fltOrgDate=<null>,depSta=DFW,schDepDateTime=<null>,disruptDepDateTime=<null>],currentSegment=com.aa.hmtautomation.eligibility.model.CurrentSegment@5649d11a[oprCd=AA,oprFltNbr=2233,mktCode=AA,mktFltNbr=4455,status=<null>,seqNbr=<null>,arrStation=<null>,depDate=20240326,depTime=2359],offer=<null>,paxList=[com.aa.hmtautomation.eligibility.model.Pax@294f9d50[seqNbr=1,firstName=<null>,lastName=<null>,classOfService=<null>,tierStatus=<null>,isWheelChair=<null>,isUM=<null>,isMinor=true,isEC261=true,isNonRev=<null>,isStandBy=<null>,hasPet=<null>,hasServicePet=<null>,isSpecialNeed=<null>,cupId=<null>,advantageNumber=<null>,isElite=true,credt=1710565200000,sSRcodes=[]]],isAPass=true,recLoc=<null>,transactionId=test-123456,portOfAccomodation=<null>,originStation=<null>,destinationStation=<null>,version=10,currencyCode=<null>,mealAmount=20,flifoCode=LMT-LATE ARRV A/C DUE TO PRIOR MAINTENANCE DELAYS-E,dsrtFltStatus=<null>]
02:42:59.678 [main] INFO com.aa.hmtautomation.offer.service.impl.OfferServiceImpl -- TransactionId: test-123456 ClassName: OfferServiceImpl method: generateContextId recloc: null
02:42:59.704 [main] INFO com.aa.hmtautomation.offer.service.impl.OfferServiceImpl -- TransactionId: test-123456 ClassName: OfferServiceImpl method: agentInFoEntry offerSeq: 0
02:42:59.705 [main] INFO com.aa.hmtautomation.offer.service.impl.OfferServiceImpl -- TransactionId: test-123456 ClassName: OfferServiceImpl method: updateOfferStatusAfterTACall passengerInfoList: []
02:42:59.785 [main] INFO com.aa.hmtautomation.offer.service.impl.OfferServiceImpl -- TransactionId: test-123456 ClassName: OfferServiceImpl method: releaseLock pnrLockEntity: null

HMTAutomationException{errorCode='400', errorMsg='Voucher id is null or empty.
'}
	at com.aa.hmtautomation.offer.service.impl.OfferServiceImpl.processMealIssuance(OfferServiceImpl.java:133)
	at com.aa.hmtautomation.offer.service.impl.OfferServiceImplTest.testProcessMealIssuance(OfferServiceImplTest.java:157)
	at java.base/java.lang.reflect.Method.invoke(Method.java:580)
	at java.base/java.util.ArrayList.forEach(ArrayList.java:1596)
	at java.base/java.util.ArrayList.forEach(ArrayList.java:1596)

02:42:59.946 [main] INFO com.aa.hmtautomation.offer.service.impl.OfferServiceImpl -- TransactionId: null ClassName: OfferServiceImpl method: offerDetailsEntry hmtAutomationPnr: com.aa.hmtautomation.eligibility.model.HMTAutomationPnr@5cf8676a[flightKey=com.aa.hmtautomation.eligibility.model.FlightKey@991cbde[fltNum=<null>,fltOrgDate=<null>,depSta=DFW,schDepDateTime=<null>,disruptDepDateTime=<null>],currentSegment=com.aa.hmtautomation.eligibility.model.CurrentSegment@78d71df1[oprCd=AA,oprFltNbr=2233,mktCode=AA,mktFltNbr=4455,status=<null>,seqNbr=<null>,arrStation=<null>,depDate=<null>,depTime=<null>],offer=com.aa.hmtautomation.eligibility.model.Offer@456bcb74[offerType=MEALS,noOfNights=1,additionalProperties={}],paxList=[],isAPass=<null>,recLoc=<null>,transactionId=<null>,portOfAccomodation=<null>,originStation=<null>,destinationStation=<null>,version=10,currencyCode=<null>,mealAmount=20,flifoCode=LMT-LATE ARRV A/C DUE TO PRIOR MAINTENANCE DELAYS-E,dsrtFltStatus=<null>]
02:42:59.951 [main] INFO com.aa.hmtautomation.offer.service.impl.OfferServiceImpl -- TransactionId: null ClassName: OfferServiceImpl method: generateContextId recloc: null
02:42:59.998 [main] INFO com.aa.hmtautomation.offer.service.impl.OfferServiceImpl -- TransactionId: null ClassName: OfferServiceImpl method: fqtvEntry hmtAutomationPnr: com.aa.hmtautomation.eligibility.model.HMTAutomationPnr@3596b249[flightKey=<null>,currentSegment=<null>,offer=<null>,paxList=[],isAPass=<null>,recLoc=<null>,transactionId=<null>,portOfAccomodation=<null>,originStation=<null>,destinationStation=<null>,version=10,currencyCode=<null>,mealAmount=<null>,flifoCode=<null>,dsrtFltStatus=<null>]
02:43:00.002 [main] INFO com.aa.hmtautomation.offer.service.impl.OfferServiceImpl -- TransactionId: null ClassName: OfferServiceImpl method: getClassOfService classOfServiceCode: null
02:43:00.064 [main] INFO com.aa.hmtautomation.offer.service.impl.OfferServiceImpl -- TransactionId: 1234-56789-6789 ClassName: OfferServiceImpl method: releaseLock pnrLockEntity: PNRLockEntity(recloc=TEST12, status=LOCKED, lockedTime=Thu Jul 04 21:13:00 GMT 2024, lastUpdatedTime=Thu Jul 04 21:13:00 GMT 2024, pnrVersion=null)
02:43:00.102 [main] INFO com.aa.hmtautomation.offer.service.impl.OfferServiceImpl -- TransactionId: 456789000034 ClassName: OfferServiceImpl method: getClassOfService classOfServiceCode: D
02:43:00.150 [main] INFO com.aa.hmtautomation.offer.service.impl.OfferServiceImpl -- TransactionId: 444455556666 ClassName: OfferServiceImpl method: getPaxStatus isNonRev: null isStandBy: null
02:43:00.188 [main] INFO com.aa.hmtautomation.offer.service.impl.OfferServiceImpl -- TransactionId: 11111-44444-55555 ClassName: OfferServiceImpl method: generateContextId recloc: TEST10
02:43:00.218 [main] INFO com.aa.hmtautomation.offer.service.impl.OfferServiceImpl -- TransactionId: 3344466666777 ClassName: OfferServiceImpl method: getClassOfService classOfServiceCode: DD
02:43:00.529 [main] INFO com.aa.hmtautomation.offer.service.impl.OfferServiceImpl -- TransactionId: 1233333-4444-44444 ClassName: OfferServiceImpl method: agentInFoEntry offerSeq: 0
02:43:00.602 [main] INFO com.aa.hmtautomation.offer.service.impl.OfferServiceImpl -- TransactionId: null ClassName: OfferServiceImpl method: pnrEntry hmtAutomationPnr: com.aa.hmtautomation.eligibility.model.HMTAutomationPnr@5099c59b[flightKey=<null>,currentSegment=<null>,offer=<null>,paxList=[com.aa.hmtautomation.eligibility.model.Pax@3a479fda[seqNbr=<null>,firstName=<null>,lastName=<null>,classOfService=<null>,tierStatus=<null>,isWheelChair=<null>,isUM=<null>,isMinor=<null>,isEC261=<null>,isNonRev=<null>,isStandBy=<null>,hasPet=<null>,hasServicePet=<null>,isSpecialNeed=<null>,cupId=<null>,advantageNumber=<null>,isElite=true,credt=<null>,sSRcodes=[]]],isAPass=<null>,recLoc=<null>,transactionId=<null>,portOfAccomodation=<null>,originStation=<null>,destinationStation=<null>,version=10,currencyCode=<null>,mealAmount=<null>,flifoCode=<null>,dsrtFltStatus=<null>]
02:43:00.664 [main] INFO com.aa.hmtautomation.offer.service.impl.OfferServiceImpl -- TransactionId: null ClassName: OfferServiceImpl method: pnrEntry hmtAutomationPnr: com.aa.hmtautomation.eligibility.model.HMTAutomationPnr@6adc5b9c[flightKey=<null>,currentSegment=<null>,offer=<null>,paxList=[com.aa.hmtautomation.eligibility.model.Pax@19c1820d[seqNbr=<null>,firstName=<null>,lastName=<null>,classOfService=<null>,tierStatus=<null>,isWheelChair=<null>,isUM=<null>,isMinor=<null>,isEC261=<null>,isNonRev=<null>,isStandBy=<null>,hasPet=<null>,hasServicePet=<null>,isSpecialNeed=<null>,cupId=<null>,advantageNumber=<null>,isElite=true,credt=<null>,sSRcodes=[]]],isAPass=<null>,recLoc=<null>,transactionId=<null>,portOfAccomodation=<null>,originStation=<null>,destinationStation=<null>,version=10,currencyCode=<null>,mealAmount=<null>,flifoCode=<null>,dsrtFltStatus=<null>]
02:43:00.727 [main] INFO com.aa.hmtautomation.offer.service.impl.OfferServiceImpl -- TransactionId: 444455555 ClassName: OfferServiceImpl method: getPaxStatus isNonRev: null isStandBy: null
02:43:00.845 [main] INFO com.aa.hmtautomation.offer.service.impl.OfferServiceImpl -- TransactionId: 1234-56789-6789 ClassName: OfferServiceImpl method: acquireLock pnrLockEntity: PNRLockEntity(recloc=TEST12, status=null, lockedTime=Thu Jul 04 21:13:00 GMT 2024, lastUpdatedTime=Thu Jul 04 21:13:00 GMT 2024, pnrVersion=null)
02:43:00.903 [main] INFO com.aa.hmtautomation.offer.service.impl.OfferServiceImpl -- TransactionId: 33334444466666 ClassName: OfferServiceImpl method: preparePnrSegEntity pnrSegKeyEntity: PnrSegKeyEntity(recloc=null, credt=null, version=null, segSeqId=null)
02:43:00.955 [main] INFO com.aa.hmtautomation.offer.service.impl.OfferServiceImpl -- TransactionId: null ClassName: OfferServiceImpl method: segmentEntry hmtAutomationPnr: com.aa.hmtautomation.eligibility.model.HMTAutomationPnr@6a32191e[flightKey=com.aa.hmtautomation.eligibility.model.FlightKey@66fbc5e7[fltNum=<null>,fltOrgDate=<null>,depSta=DFW,schDepDateTime=<null>,disruptDepDateTime=<null>],currentSegment=com.aa.hmtautomation.eligibility.model.CurrentSegment@9accff0[oprCd=AA,oprFltNbr=2233,mktCode=AA,mktFltNbr=4455,status=<null>,seqNbr=<null>,arrStation=<null>,depDate=<null>,depTime=<null>],offer=<null>,paxList=[com.aa.hmtautomation.eligibility.model.Pax@52559a69[seqNbr=1,firstName=<null>,lastName=<null>,classOfService=<null>,tierStatus=<null>,isWheelChair=<null>,isUM=<null>,isMinor=<null>,isEC261=<null>,isNonRev=<null>,isStandBy=<null>,hasPet=<null>,hasServicePet=<null>,isSpecialNeed=<null>,cupId=<null>,advantageNumber=<null>,isElite=<null>,credt=<null>,sSRcodes=[]]],isAPass=<null>,recLoc=<null>,transactionId=<null>,portOfAccomodation=<null>,originStation=<null>,destinationStation=<null>,version=10,currencyCode=<null>,mealAmount=<null>,flifoCode=<null>,dsrtFltStatus=<null>]
02:43:00.966 [main] INFO com.aa.hmtautomation.offer.service.impl.OfferServiceImpl -- TransactionId: null ClassName: OfferServiceImpl method: preparePnrSegEntity pnrSegKeyEntity: PnrSegKeyEntity(recloc=null, credt=2024-03-16 05:00:00.0, version=10, segSeqId=null)
02:43:01.041 [main] INFO com.aa.hmtautomation.offer.service.impl.OfferServiceImpl -- TransactionId: null ClassName: OfferServiceImpl method: ssrEntry hmtAutomationPnr: com.aa.hmtautomation.eligibility.model.HMTAutomationPnr@22bf9122[flightKey=<null>,currentSegment=<null>,offer=<null>,paxList=[com.aa.hmtautomation.eligibility.model.Pax@73afe2b7[seqNbr=1,firstName=<null>,lastName=<null>,classOfService=<null>,tierStatus=<null>,isWheelChair=<null>,isUM=<null>,isMinor=<null>,isEC261=<null>,isNonRev=<null>,isStandBy=<null>,hasPet=<null>,hasServicePet=<null>,isSpecialNeed=<null>,cupId=<null>,advantageNumber=<null>,isElite=<null>,credt=<null>,sSRcodes=[WCLB]]],isAPass=<null>,recLoc=TEST12,transactionId=<null>,portOfAccomodation=<null>,originStation=<null>,destinationStation=<null>,version=10,currencyCode=<null>,mealAmount=<null>,flifoCode=<null>,dsrtFltStatus=<null>]
02:43:01.084 [main] INFO com.aa.hmtautomation.offer.service.impl.OfferServiceImpl -- TransactionId: 444455556666 ClassName: OfferServiceImpl method: getPaxStatus isNonRev: null isStandBy: true
02:43:01.154 [main] INFO com.aa.hmtautomation.offer.service.impl.OfferServiceImpl -- TransactionId: test12345 ClassName: OfferServiceImpl method: updateOfferStatusAfterTACall passengerInfoList: [PassengerInfo(phone_numbers=null, emails=null, expiration_date=2024-06-06, voucher_id=12345, id=0, email_sent_date=null, post_code=null, modified_date=2024-06-06 01:20:05, status=null, canceled_date=null, text_sent=false, email_sent=false, denied_date=null, offer_url=localhost://test, text_sent_date=2024-06-06, state=null, context_id=134567, pax_record_locator=null, pax_record_locator_group=null, scheduled_depart=null, pnr_create_date=null, flight_number=1234, disrupt_type=null, requester=null, first_name=null, last_name=null, pax_status=null, port_origin=null, port_accommodation=DFW, hotel_accommodation=false, meal_accommodation=false, transport_accommodation=false, life_stage=null, service_pet=false, handicap=false, notify=false, disrupt_depart=null, airline_pay=false, number_of_nights=0, airline_id=0, hotel_active_from_date=null, hotel_active_to_date=null, error_message=Invalid data, meals=null, create_date=2024-06-06 01:20:05, ticket_level=null, pet=false, notifications=null)]
02:43:01.367 [main] INFO com.aa.hmtautomation.offer.service.impl.OfferServiceImpl -- TransactionId: test12345 ClassName: OfferServiceImpl method: mappingTaCallResponseToOfferDetails passengerInfo: PassengerInfo(phone_numbers=null, emails=null, expiration_date=2024-06-06, voucher_id=12345, id=0, email_sent_date=null, post_code=null, modified_date=2024-06-06 01:20:05, status=null, canceled_date=null, text_sent=false, email_sent=false, denied_date=null, offer_url=localhost://test, text_sent_date=2024-06-06, state=null, context_id=134567, pax_record_locator=null, pax_record_locator_group=null, scheduled_depart=null, pnr_create_date=null, flight_number=1234, disrupt_type=null, requester=null, first_name=null, last_name=null, pax_status=null, port_origin=null, port_accommodation=DFW, hotel_accommodation=false, meal_accommodation=false, transport_accommodation=false, life_stage=null, service_pet=false, handicap=false, notify=false, disrupt_depart=null, airline_pay=false, number_of_nights=0, airline_id=0, hotel_active_from_date=null, hotel_active_to_date=null, error_message=Invalid data, meals=null, create_date=2024-06-06 01:20:05, ticket_level=null, pet=false, notifications=null) offerDetails: OfferDetails(contextId=null, selftServe=null, offerSeq=0, recloc=null, credt=null, version=null, paxSeq=null, offerStatus=null, pnrGroupId=null, numberOfNights=0, mealAmount=0.0, currencyCode=null, numberOfMeals=0, aaPay=null, flightCode=null, transportTime=null, transport=null, cupid=null, createdTime=null, modifiedTime=null, portAccomodation=null, airlineId=0, offerVersion=null, emailSent=null, notify=null, emailSentDate=null, expirationDate=null, importedId=0, offerUrl=null, errorMessage=null, textSent=null, textSentDate=null, voucherId=null, hotelOffer=null, mealOffer=true, transportOffer=null, issueTime=null, hotelStatus=null, mealStatus=null, transportStatus=null, transportReturn=null, mealIssueDate=null, mealExpiryDate=null, checkInTime=null, checkOutTime=null, refMessageTimestamp=null, lastUpdTms=null, issueTimeGmt=null, mealExpiryDateGmt=null, checkInTimeGmt=null, checkOutTimeGmt=null, lifestage=null, requestType=null, authorizedBy=null, reasonCode=null, agentEnumber=null, transPortExpiryDateInGmt=null, refNum=null, primaryPassenger=null, isEC261=null, issuanceTransactionId=null)
02:43:01.666 [main] INFO com.aa.hmtautomation.offer.service.impl.OfferServiceImpl -- TransactionId: 1234-56789-6789 ClassName: OfferServiceImpl method: acquireLock pnrLockEntity: PNRLockEntity(recloc=TEST12, status=LOCKED, lockedTime=Thu Jul 04 21:12:31 GMT 2024, lastUpdatedTime=Thu Jul 04 21:13:01 GMT 2024, pnrVersion=null)
02:43:01.687 [main] INFO com.aa.hmtautomation.offer.service.impl.OfferServiceImpl -- TransactionId: null ClassName: OfferServiceImpl method: paxEntry hmtAutomationPnr: com.aa.hmtautomation.eligibility.model.HMTAutomationPnr@6002e944[flightKey=<null>,currentSegment=<null>,offer=<null>,paxList=[],isAPass=true,recLoc=<null>,transactionId=<null>,portOfAccomodation=<null>,originStation=<null>,destinationStation=<null>,version=10,currencyCode=<null>,mealAmount=<null>,flifoCode=<null>,dsrtFltStatus=<null>]
02:43:01.691 [main] INFO com.aa.hmtautomation.offer.service.impl.OfferServiceImpl -- TransactionId: null ClassName: OfferServiceImpl method: getPaxStatus isNonRev: null isStandBy: null

Process finished with exit code -1


05-07-2024 :- 
// test/java/com.aa.hmtautomation/offer.service.impl/OfferServiceImplTest :-
package com.aa.hmtautomation.offer.service.impl;

import com.aa.hmtautomation.ApplicationConstants;
import com.aa.hmtautomation.DbCodesCachingUtil;
import com.aa.hmtautomation.db.entity.PNRLockEntity;
import com.aa.hmtautomation.db.entity.PnrTable;
import com.aa.hmtautomation.db.entity.SsrCodeMappings;
import com.aa.hmtautomation.db.entity.PnrSegEntity;
import com.aa.hmtautomation.db.entity.PnrPaxEntity;
import com.aa.hmtautomation.db.entity.PnrFqtvEntity;
import com.aa.hmtautomation.db.entity.PnrSegKeyEntity;
import com.aa.hmtautomation.db.entity.ClassOfServiceMappings;
import com.aa.hmtautomation.db.entity.PnrSsrEntity;
import com.aa.hmtautomation.db.entity.OfferMaster;
import com.aa.hmtautomation.db.entity.OfferDetails;
import com.aa.hmtautomation.db.entity.AgentInfoEntity;
import com.aa.hmtautomation.db.repository.PNRLockEntityRepository;
import com.aa.hmtautomation.db.repository.PnrTableRepository;
import com.aa.hmtautomation.db.repository.PnrSegEntityRepository;
import com.aa.hmtautomation.db.repository.PnrPaxEntityRepository;
import com.aa.hmtautomation.db.repository.PnrFqtvEntityRepository;
import com.aa.hmtautomation.db.repository.PnrSsrEntityRepository;
import com.aa.hmtautomation.db.repository.OfferMasterRepository;
import com.aa.hmtautomation.db.repository.OfferDetailsRepository;
import com.aa.hmtautomation.db.repository.AgentInfoEntityRepository;
import com.aa.hmtautomation.eligibility.model.CurrentSegment;
import com.aa.hmtautomation.eligibility.model.FlightKey;
import com.aa.hmtautomation.eligibility.model.HMTAutomationPnr;
import com.aa.hmtautomation.eligibility.model.Pax;
import com.aa.hmtautomation.eligibility.model.Offer;
import com.aa.hmtautomation.exception.HMTAutomationException;
import com.aa.hmtautomation.travelalliance.model.Data;
import com.aa.hmtautomation.travelalliance.model.HMTAVoucher;
import com.aa.hmtautomation.travelalliance.model.PassengerInfo;
import com.aa.hmtautomation.travelalliance.service.TravelService;
import com.aa.hmtautomation.travelalliance.service.VoucherService;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.mockito.junit.jupiter.MockitoExtension;
import org.springframework.test.util.ReflectionTestUtils;
import org.springframework.web.client.RestTemplate;
import java.math.BigInteger;
import java.sql.Timestamp;
import java.time.ZoneOffset;
import java.time.ZonedDateTime;
import java.util.ArrayList;
import java.util.Date;
import java.util.List;
import java.util.Optional;
import java.util.TimeZone;
import static org.junit.jupiter.api.Assertions.assertEquals;
import static org.junit.jupiter.api.Assertions.assertTrue;
import static org.junit.jupiter.api.Assertions.assertThrows;
import static org.junit.jupiter.api.Assertions.assertNull;
import static org.junit.jupiter.api.Assertions.assertNotNull;
import static org.mockito.ArgumentMatchers.any;
import static org.mockito.ArgumentMatchers.anyString;
import static org.mockito.Mockito.atLeastOnce;
import static org.mockito.Mockito.when;
import static org.mockito.Mockito.verify;
import static org.mockito.Mockito.times;
import static org.mockito.Mockito.spy;
import static org.mockito.Mockito.mock;

@ExtendWith(MockitoExtension.class)
class OfferServiceImplTest {

    @InjectMocks
    private OfferServiceImpl offerService;

    @Mock
    private PNRLockEntityRepository pnrLockEntityRepository;

    @Mock
    private PnrTableRepository pnrTableRepository;

    @Mock
    private PnrSegEntityRepository pnrSegEntityRepository;

    @Mock
    private PnrPaxEntityRepository pnrPaxEntityRepository;

    @Mock
    private PnrFqtvEntityRepository pnrFqtvEntityRepository;

    @Mock
    private PnrSsrEntityRepository pnrSsrEntityRepository;

    @Mock
    private DbCodesCachingUtil dbCodesCachingUtil;

    @Mock
    private OfferMasterRepository offerMasterRepository;

    @Mock
    private OfferDetailsRepository offerDetailsRepository;

    @Mock
    private AgentInfoEntityRepository agentInfoEntityRepository;

    @Mock
    RestTemplate restTemplate;

    @Mock
    private TravelService travelService;

    @Mock
    private VoucherService voucherService;

    @Test
    public void testProcessMealIssuance(){
        //Arrange
        HMTAVoucher hmtVoucher = new HMTAVoucher(new Data(), null, null);
        HMTAutomationPnr hmtAutomationPnr = new HMTAutomationPnr();
        List<PassengerInfo> passengerInfoList = new ArrayList<>();
        PassengerInfo passengerInfo = new PassengerInfo();
        passengerInfo.setVoucher_id("testVoucherId1");

// 05-07-2024
        passengerInfoList.add(passengerInfo);


        Pax pax = new Pax();
        pax.setSeqNbr(1);
        pax.setIsElite(Boolean.TRUE);
        pax.setCredt("1710565200000");
        pax.setIsMinor(Boolean.TRUE);
        pax.setIsEC261(Boolean.TRUE);

        CurrentSegment currentSegment = new CurrentSegment();
        currentSegment.setOprCd("AA");
        currentSegment.setOprFltNbr("2233");
        currentSegment.setMktCode("AA");
        currentSegment.setMktFltNbr("4455");
        currentSegment.setDepDate("20240326");
        currentSegment.setDepTime("2359");

        FlightKey flightKey = new FlightKey();
        flightKey.setDepSta("DFW");

        hmtAutomationPnr.setMealAmount("20");
        hmtAutomationPnr.setVersion(10);
        hmtAutomationPnr.setIsAPass(Boolean.TRUE);
        hmtAutomationPnr.setFlifoCode("LMT-LATE ARRV A/C DUE TO PRIOR MAINTENANCE DELAYS-E");
        hmtAutomationPnr.setCurrentSegment(currentSegment);
        hmtAutomationPnr.setFlightKey(flightKey);
        hmtAutomationPnr.setPaxList(List.of(pax));
        hmtAutomationPnr.setTransactionId("test-123456");

        //Mock the dependencies
        when(pnrTableRepository.saveAndFlush(any())).thenReturn(new PnrTable());
        when(pnrSegEntityRepository.saveAndFlush(any())).thenReturn(new PnrSegEntity());
        when(pnrPaxEntityRepository.saveAndFlush(any())).thenReturn(new PnrPaxEntity());
        when(pnrFqtvEntityRepository.saveAndFlush(any())).thenReturn(new PnrFqtvEntity());
        when(offerMasterRepository.saveAndFlush(any())).thenReturn(new OfferMaster());
        when(travelService.importPassengersToTravelAlliance(any(HMTAutomationPnr.class))).thenReturn(passengerInfoList);

        //Act
        offerService.processMealIssuance(hmtAutomationPnr);

        //Assert
        verify(travelService, atLeastOnce()).importPassengersToTravelAlliance(hmtAutomationPnr);

    }

    @Test
    public void testAcquireLock(){
        //Arrange
        PNRLockEntity pnrLockEntity = new PNRLockEntity();
        pnrLockEntity.setRecloc("TEST12");
        pnrLockEntity.setLockedTime(new Date());
        pnrLockEntity.setLastUpdatedTime(new Date());

        //Mock the dependencies
        when(pnrLockEntityRepository.findById(anyString())).thenReturn(Optional.of(pnrLockEntity));

        //Act
        boolean topTierStatus = Boolean.TRUE.equals(ReflectionTestUtils.
                invokeMethod(offerService, "acquireLock", "TEST12", "1234-56789-6789"));

        //Assert
        assertTrue(topTierStatus);
    }

    @Test
    public void testAcquireLockByAnotherPnrMealIssuance_whenException(){
        //Arrange
        PNRLockEntity pnrLockEntity = new PNRLockEntity();
        pnrLockEntity.setRecloc("TEST12");
        pnrLockEntity.setLockedTime(new Date(new Date().getTime() - (30000L)));
        pnrLockEntity.setLastUpdatedTime(new Date());
        pnrLockEntity.setStatus("LOCKED");

        //Mock the dependencies
        when(pnrLockEntityRepository.findById(anyString())).thenReturn(Optional.of(pnrLockEntity));

        //Act
        HMTAutomationException exception = assertThrows(HMTAutomationException.class, () ->
                ReflectionTestUtils.invokeMethod(offerService, "acquireLock", "TEST12", "1234-56789-6789"));

        //Assert
        assertEquals(exception.getErrorCode(), "400");
        assertEquals(exception.getErrorMsg(), "This PNR locked for another meal issuance. " +
                "Please retry after some time.");
    }

    @Test
    public void testReleaseLock(){
        //Arrange
        PNRLockEntity pnrLockEntity = new PNRLockEntity();
        pnrLockEntity.setRecloc("TEST12");
        pnrLockEntity.setLockedTime(new Date());
        pnrLockEntity.setLastUpdatedTime(new Date());
        pnrLockEntity.setStatus("LOCKED");

        //Mock the dependencies
        when(pnrLockEntityRepository.findById(anyString())).thenReturn(Optional.of(pnrLockEntity));

        //Act
        ReflectionTestUtils.invokeMethod(offerService, "releaseLock", "TEST12", "1234-56789-6789");

        //Assert
        verify(pnrLockEntityRepository, times(BigInteger.ONE.intValue())).saveAndFlush(any());
    }

    @Test
    public void testMealIssuanceEntry(){
        //Arrange
        HMTAutomationPnr hmtAutomationPnr = spy(HMTAutomationPnr.class);
        Pax pax = new Pax();
        pax.setIsElite(true);
        hmtAutomationPnr.setVersion(10);
        hmtAutomationPnr.setPaxList(List.of(pax));
        TimeZone.setDefault(TimeZone.getTimeZone(ApplicationConstants.INSTANCE.GMT_TZ));
        Timestamp createdDate = new Timestamp(Long.parseLong("1710565200000"));

        //Mock the dependencies
        when(pnrTableRepository.saveAndFlush(any())).thenReturn(new PnrTable());

        //Act
        ReflectionTestUtils.invokeMethod(offerService, "pnrEntry", hmtAutomationPnr, createdDate);

        //Assert
        verify(hmtAutomationPnr, times(BigInteger.ONE.intValue())).getRecLoc();
    }

    @Test
    public void testPnrEntry(){
        //Arrange
        HMTAutomationPnr hmtAutomationPnr = spy(HMTAutomationPnr.class);
        Pax pax = new Pax();
        pax.setIsElite(true);
        hmtAutomationPnr.setVersion(10);
        hmtAutomationPnr.setPaxList(List.of(pax));
        TimeZone.setDefault(TimeZone.getTimeZone(ApplicationConstants.INSTANCE.GMT_TZ));
        Timestamp createdDate = new Timestamp(Long.parseLong("1710565200000"));

        //Mock the dependencies
        when(pnrTableRepository.saveAndFlush(any())).thenReturn(new PnrTable());

        //Act
        ReflectionTestUtils.invokeMethod(offerService, "pnrEntry", hmtAutomationPnr, createdDate);

        //Assert
        verify(hmtAutomationPnr, times(BigInteger.ONE.intValue())).getTransactionId();
        verify(pnrTableRepository, times(BigInteger.ONE.intValue())).saveAndFlush(any());
    }

    @Test
    public void testSegmentEntry(){
        //Arrange
        HMTAutomationPnr hmtAutomationPnr = spy(HMTAutomationPnr.class);
        Pax pax = new Pax();
        pax.setSeqNbr(1);
        hmtAutomationPnr.setVersion(10);

        CurrentSegment currentSegment = new CurrentSegment();
        currentSegment.setOprCd("AA");
        currentSegment.setOprFltNbr("2233");
        currentSegment.setMktCode("AA");
        currentSegment.setMktFltNbr("4455");

        FlightKey flightKey = new FlightKey();
        flightKey.setDepSta("DFW");

        hmtAutomationPnr.setCurrentSegment(currentSegment);
        hmtAutomationPnr.setFlightKey(flightKey);
        hmtAutomationPnr.setPaxList(List.of(pax));
        TimeZone.setDefault(TimeZone.getTimeZone(ApplicationConstants.INSTANCE.GMT_TZ));
        Timestamp createdDate = new Timestamp(Long.parseLong("1710565200000"));

        //Mock the dependencies
        when(pnrSegEntityRepository.saveAndFlush(any())).thenReturn(new PnrSegEntity());

        //Act
        ReflectionTestUtils.invokeMethod(offerService, "segmentEntry", hmtAutomationPnr, createdDate);

        //Assert
        verify(hmtAutomationPnr, times(BigInteger.TWO.intValue())).getTransactionId();
        verify(pnrSegEntityRepository, times(BigInteger.ONE.intValue())).saveAndFlush(any());
    }

    @Test
    public void testPaxEntry() {
        //Arrange
        HMTAutomationPnr hmtAutomationPnr = spy(HMTAutomationPnr.class);
        Pax pax = new Pax();
        pax.setSeqNbr(1);
        hmtAutomationPnr.setVersion(10);
        hmtAutomationPnr.setIsAPass(Boolean.TRUE);
        TimeZone.setDefault(TimeZone.getTimeZone(ApplicationConstants.INSTANCE.GMT_TZ));
        Timestamp createdDate = new Timestamp(Long.parseLong("1710565200000"));

        //Mock the dependencies
        when(pnrPaxEntityRepository.saveAndFlush(any())).thenReturn(new PnrPaxEntity());

        //Act
        ReflectionTestUtils.invokeMethod(offerService, "paxEntry", hmtAutomationPnr, pax, createdDate);

        //Assert
        verify(hmtAutomationPnr, times(BigInteger.TWO.intValue())).getTransactionId();
        verify(pnrPaxEntityRepository, times(BigInteger.ONE.intValue())).saveAndFlush(any());
    }

    @Test
    public void testFqtvEntry() {
        //Arrange
        HMTAutomationPnr hmtAutomationPnr = spy(HMTAutomationPnr.class);
        Pax pax = new Pax();
        pax.setSeqNbr(1);
        hmtAutomationPnr.setVersion(10);
        TimeZone.setDefault(TimeZone.getTimeZone(ApplicationConstants.INSTANCE.GMT_TZ));
        Timestamp createdDate = new Timestamp(Long.parseLong("1710565200000"));

        //Mock the dependencies
        when(pnrFqtvEntityRepository.saveAndFlush(any())).thenReturn(new PnrFqtvEntity());

        //Act
        ReflectionTestUtils.invokeMethod(offerService, "fqtvEntry", hmtAutomationPnr, pax, createdDate);

        //Assert
        verify(hmtAutomationPnr, times(BigInteger.TWO.intValue())).getTransactionId();
        verify(pnrFqtvEntityRepository, times(BigInteger.ONE.intValue())).saveAndFlush(any());
    }

    @Test
    public void testSsrEntry() {
        //Arrange
        HMTAutomationPnr hmtAutomationPnr = spy(HMTAutomationPnr.class);
        Pax pax = new Pax();
        pax.setSeqNbr(1);
        pax.setsSRcodes(List.of("WCLB"));

        hmtAutomationPnr.setVersion(10);
        hmtAutomationPnr.setRecLoc("TEST12");
        hmtAutomationPnr.setPaxList(List.of(pax));

        SsrCodeMappings ssrCodeMappings = new SsrCodeMappings();
        ssrCodeMappings.setSsrCode("WCLB");
        ssrCodeMappings.setSsrCodeDescription("Customer travelling with lithium battery wheelchair");
        TimeZone.setDefault(TimeZone.getTimeZone(ApplicationConstants.INSTANCE.GMT_TZ));
        Timestamp createdDate = new Timestamp(Long.parseLong("1710565200000"));

        //Mock the dependencies
        when(dbCodesCachingUtil.getSsrCodeMappings(anyString())).thenReturn(ssrCodeMappings);
        when(pnrSsrEntityRepository.saveAndFlush(any())).thenReturn(new PnrSsrEntity());

        //Act
        ReflectionTestUtils.invokeMethod(offerService, "ssrEntry", hmtAutomationPnr, pax, createdDate);

        //Assert
        verify(hmtAutomationPnr, times(BigInteger.ONE.intValue())).getTransactionId();
        verify(pnrSsrEntityRepository, times(BigInteger.ONE.intValue())).saveAndFlush(any());
    }

    @Test
    public void testGetPaxStatus_whenIsNonRevTrue() {
        //Act
        String result = ReflectionTestUtils.invokeMethod(offerService, "getPaxStatus", Boolean.TRUE,
                null, Boolean.FALSE, "444455555666");

        //Assert
        assertEquals(result, "NON REV");
    }

    @Test
    public void testGetPaxStatus_whenIsStandByTrue() {
        //Act
        String result = ReflectionTestUtils.invokeMethod(offerService, "getPaxStatus", null,
                Boolean.TRUE, Boolean.FALSE, "444455556666");

        //Assert
        assertEquals(result, "STAND BY");
    }

    @Test
    public void testGetPaxStatus_whenIsAPassTrue() {
        //Act
        String result = ReflectionTestUtils.invokeMethod(offerService, "getPaxStatus", null, null,
                Boolean.TRUE, "444455556666");

        //Assert
        assertEquals(result, "APASS");
    }

    @Test
    public void testGetPaxStatus_whenReturnNull() {
        //Act
        String result = ReflectionTestUtils.invokeMethod(offerService, "getPaxStatus", null, null,
                Boolean.FALSE, "444455555");

        //Assert
        assertNull(result);
    }

    @Test
    public void testPreparePnrSegEntity() {
        //Arrange
        CurrentSegment currentSegment = new CurrentSegment();
        currentSegment.setOprCd("AA");
        currentSegment.setOprFltNbr("2233");
        currentSegment.setMktCode("AA");
        currentSegment.setMktFltNbr("4455");

        //Act
        PnrSegEntity pnrSegEntity = ReflectionTestUtils.invokeMethod(offerService,
                "preparePnrSegEntity", currentSegment, "DFW", new PnrSegKeyEntity(), "33334444466666");

        //Assert
        assertNotNull(pnrSegEntity);
        assertEquals("AA", pnrSegEntity.getOpCrirCd());
        assertEquals("2233", pnrSegEntity.getOpFltNmbr());
        assertEquals("AA", pnrSegEntity.getMktCrirCd());
        assertEquals("4455", pnrSegEntity.getMktFltNmbr());
        assertNull(currentSegment.getStatus());
        assertNull(currentSegment.getSeqNbr());
    }

    @Test
    public void testGetClassOfService() {
        //Arrange
        ClassOfServiceMappings classOfServiceMappings = new ClassOfServiceMappings();
        classOfServiceMappings.setClassOfServiceCodes("D");
        classOfServiceMappings.setClassOfService("BUSINESS CLASS");

        //Mock the dependencies
        when(dbCodesCachingUtil.getClassOfServiceMappings(anyString())).thenReturn(Optional.of(classOfServiceMappings));

        //Act
        String result = ReflectionTestUtils.invokeMethod(offerService, "getClassOfService", "D",
                "456789000034");

        //Assert
        assertEquals(result, "BUSINESS CLASS");
    }

    @Test
    public void testGetClassOfService_whenReturnNull() {
        //Mock the dependencies
        when(dbCodesCachingUtil.getClassOfServiceMappings(anyString())).thenReturn(Optional.of(new ClassOfServiceMappings()));

        //Act
        String result = ReflectionTestUtils.invokeMethod(offerService, "getClassOfService", "DD",
                "3344466666777");

        //Assert
        assertNull(result);
    }

    @Test
    public void testOfferMasterEntry() {
        //Arrange
        HMTAutomationPnr hmtAutomationPnr = spy(HMTAutomationPnr.class);
        Pax pax = new Pax();
        pax.setSeqNbr(1);
        pax.setCredt("1710565200000");
        CurrentSegment currentSegment = new CurrentSegment();
        currentSegment.setOprCd("AA");
        currentSegment.setOprFltNbr("2233");
        currentSegment.setMktCode("AA");
        currentSegment.setMktFltNbr("4455");
        currentSegment.setDepDate("20240326");
        currentSegment.setDepTime("2359");
        FlightKey flightKey = new FlightKey();
        flightKey.setDepSta("DFW");
        hmtAutomationPnr.setVersion(10);
        hmtAutomationPnr.setCurrentSegment(currentSegment);
        hmtAutomationPnr.setFlightKey(flightKey);
        TimeZone.setDefault(TimeZone.getTimeZone(ApplicationConstants.INSTANCE.GMT_TZ));
        Timestamp createdDate = new Timestamp(Long.parseLong("1710565200000"));
        OfferMaster offerMaster = new OfferMaster();
        offerMaster.setFlightNumber("2233");
        offerMaster.setDisFltDepDate("20240326 23:59");

        //Mock the dependencies
        when(offerMasterRepository.saveAndFlush(any())).thenReturn(offerMaster);

        //Act
        OfferMaster offerMasterRes = ReflectionTestUtils.invokeMethod(offerService, "offerMasterEntry",
                hmtAutomationPnr, createdDate, currentSegment);

        //Assert
        assertNotNull(offerMasterRes);
        assertEquals("2233", offerMasterRes.getFlightNumber());
        assertEquals(offerMasterRes.getDisFltDepDate(), "20240326 23:59");
        verify(hmtAutomationPnr, times(BigInteger.TWO.intValue())).getFlightKey();
        verify(offerMasterRepository, times(BigInteger.ONE.intValue())).saveAndFlush(any());
    }

    @Test
    public void testOfferDetailsEntry() {
        //Arrange
        HMTAutomationPnr hmtAutomationPnr = spy(HMTAutomationPnr.class);
        Pax pax = new Pax();
        pax.setSeqNbr(1);
        pax.setCredt("1710565200000");
        pax.setIsMinor(Boolean.TRUE);
        pax.setIsEC261(Boolean.TRUE);
        CurrentSegment currentSegment = new CurrentSegment();
        currentSegment.setOprCd("AA");
        currentSegment.setOprFltNbr("2233");
        currentSegment.setMktCode("AA");
        currentSegment.setMktFltNbr("4455");
        FlightKey flightKey = new FlightKey();
        flightKey.setDepSta("DFW");
        Offer offer = new Offer();
        offer.setOfferType(Offer.OfferType.MEALS);
        offer.setNoOfNights(1);
        hmtAutomationPnr.setFlifoCode("LMT-LATE ARRV A/C DUE TO PRIOR MAINTENANCE DELAYS-E");
        hmtAutomationPnr.setOffer(offer);
        hmtAutomationPnr.setVersion(10);
        hmtAutomationPnr.setMealAmount("20");
        hmtAutomationPnr.setCurrentSegment(currentSegment);
        hmtAutomationPnr.setFlightKey(flightKey);
        TimeZone.setDefault(TimeZone.getTimeZone("GMT"));
        Timestamp timestamp = Timestamp.from(ZonedDateTime.now(ZoneOffset.UTC).toInstant());
        TimeZone.setDefault(TimeZone.getTimeZone(ApplicationConstants.INSTANCE.GMT_TZ));
        Timestamp createdDate = new Timestamp(Long.parseLong("1710565200000"));
        OfferMaster offerMaster = new OfferMaster();
        offerMaster.setOfferSeq(1234567L);

        //Mock the dependencies
        when(offerDetailsRepository.saveAndFlush(any())).thenReturn(new OfferDetails());

        //Act
        ReflectionTestUtils.invokeMethod(offerService, "offerDetailsEntry", hmtAutomationPnr, pax, timestamp,
                offerMaster, createdDate);

        //Assert
        verify(hmtAutomationPnr, times(BigInteger.TWO.intValue())).getVersion();
        verify(offerDetailsRepository, times(BigInteger.ONE.intValue())).saveAndFlush(any());
    }

    @Test
    public void testAgentInFoEntry() {
        //Arrange
        OfferMaster offerMaster = mock(OfferMaster.class);
        offerMaster.setOfferSeq(2345456L);
        TimeZone.setDefault(TimeZone.getTimeZone(ApplicationConstants.INSTANCE.GMT_TZ));
        offerMaster.setLastUpdatedTime(new Timestamp(Long.parseLong("1710565200000")));

        //Mock the dependencies
        when(agentInfoEntityRepository.saveAndFlush(any())).thenReturn(new AgentInfoEntity());

        //Act
        ReflectionTestUtils.invokeMethod(offerService, "agentInfoEntry", offerMaster, "1233333-4444-44444");

        //Assert
        verify(offerMaster, times(BigInteger.ONE.intValue())).getLastUpdatedTime();
        verify(agentInfoEntityRepository, times(BigInteger.ONE.intValue())).saveAndFlush(any());
    }

    @Test
    public void testGenerateContextId() {
        //Arrange
        TimeZone.setDefault(TimeZone.getTimeZone(ApplicationConstants.INSTANCE.GMT_TZ));
        Timestamp createdDate = new Timestamp(Long.parseLong("1710565200000"));

        //Act
        String result = ReflectionTestUtils.invokeMethod(offerService, "generateContextId", "TEST10",
                createdDate, 1, 10, 111223344L, "11111-44444-55555");

        //Assert
        assertNotNull(result);
        assertEquals(result, "TEST101710565200000111223344110M");
    }

    @Test
    public void testUpdateOfferStatusAfterTACall() {
        // Arrange
        List<PassengerInfo> passengerInfoList = new ArrayList<>();
        PassengerInfo passengerInfo = new PassengerInfo();
        passengerInfo.setFlight_number("1234");
        passengerInfo.setOffer_url("localhost://test");
        passengerInfo.setVoucher_id("12345");
        passengerInfo.setContext_id("134567");
        passengerInfo.setExpiration_date("2024-06-06");
        passengerInfo.setText_sent_date("2024-06-06");
        passengerInfo.setPort_accommodation("DFW");
        passengerInfo.setError_message("Invalid data");
        passengerInfo.setCreate_date("2024-06-06 01:20:05");
        passengerInfo.setModified_date("2024-06-06 01:20:05");
        passengerInfoList.add(passengerInfo);
        String transactionId = "test12345";
        OfferDetails offerDetails = new OfferDetails();
        offerDetails.setMealOffer("true");

        // Mock the dependencies
        when(offerDetailsRepository.findByContextId(anyString())).thenReturn(offerDetails);

        // Act
        ReflectionTestUtils.invokeMethod(offerService,
                "updateOfferStatusAfterTACall", passengerInfoList, transactionId);

        // Assert
        verify(offerDetailsRepository, times(BigInteger.ONE.intValue())).saveAndFlush(any());
    }

}

// java/com.aa.hmtautomation/offer.service/impl/OfferServiceImpl :-
package com.aa.hmtautomation.offer.service.impl;

import com.aa.hmtautomation.ApplicationConstants;
import com.aa.hmtautomation.ApplicationUtils;
import com.aa.hmtautomation.DbCodesCachingUtil;
import com.aa.hmtautomation.db.entity.OfferMaster;
import com.aa.hmtautomation.db.entity.PnrSsrKeyEntity;
import com.aa.hmtautomation.db.entity.PnrSsrEntity;
import com.aa.hmtautomation.db.entity.PnrPaxKeyEntity;
import com.aa.hmtautomation.db.entity.PnrPaxEntity;
import com.aa.hmtautomation.db.entity.PNRLockEntity;
import com.aa.hmtautomation.db.entity.PnrFqtvKeyEntity;
import com.aa.hmtautomation.db.entity.PnrFqtvEntity;
import com.aa.hmtautomation.db.entity.PnrTableKeyEntity;
import com.aa.hmtautomation.db.entity.PnrTable;
import com.aa.hmtautomation.db.entity.PnrSegKeyEntity;
import com.aa.hmtautomation.db.entity.PnrSegEntity;
import com.aa.hmtautomation.db.entity.ClassOfServiceMappings;
import com.aa.hmtautomation.db.entity.OfferDetails;
import com.aa.hmtautomation.db.entity.AgentInfoEntity;
import com.aa.hmtautomation.db.repository.OfferDetailsRepository;
import com.aa.hmtautomation.db.repository.PNRLockEntityRepository;
import com.aa.hmtautomation.db.repository.PnrTableRepository;
import com.aa.hmtautomation.db.repository.PnrSegEntityRepository;
import com.aa.hmtautomation.db.repository.PnrPaxEntityRepository;
import com.aa.hmtautomation.db.repository.PnrFqtvEntityRepository;
import com.aa.hmtautomation.db.repository.PnrSsrEntityRepository;
import com.aa.hmtautomation.db.repository.OfferMasterRepository;
import com.aa.hmtautomation.db.repository.AgentInfoEntityRepository;
import com.aa.hmtautomation.eligibility.model.CurrentSegment;
import com.aa.hmtautomation.eligibility.model.HMTAutomationPnr;
import com.aa.hmtautomation.eligibility.model.Pax;
import com.aa.hmtautomation.eventprocessor.enums.OfferStatusEnum;
import com.aa.hmtautomation.exception.HMTAutomationException;
import com.aa.hmtautomation.offer.service.OfferService;
import com.aa.hmtautomation.travelalliance.model.HMTAVoucher;
import com.aa.hmtautomation.travelalliance.model.PassengerInfo;
import com.aa.hmtautomation.travelalliance.service.TravelService;
import com.aa.hmtautomation.travelalliance.service.VoucherService;
import lombok.extern.slf4j.Slf4j;
import org.apache.commons.lang3.StringUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import java.math.BigInteger;
import java.sql.Timestamp;
import java.time.Instant;
import java.time.ZoneOffset;
import java.time.ZonedDateTime;
import java.util.Date;
import java.util.List;
import java.util.Objects;
import java.util.Optional;
import java.util.TimeZone;
import java.util.concurrent.atomic.AtomicInteger;

@Service
@Slf4j
public class OfferServiceImpl implements OfferService {

    @Autowired
    private PNRLockEntityRepository pnrLockEntityRepository;

    @Autowired
    private PnrTableRepository pnrTableRepository;

    @Autowired
    private PnrSegEntityRepository pnrSegEntityRepository;

    @Autowired
    private PnrPaxEntityRepository pnrPaxEntityRepository;

    @Autowired
    private PnrFqtvEntityRepository pnrFqtvEntityRepository;

    @Autowired
    private PnrSsrEntityRepository pnrSsrEntityRepository;

    @Autowired
    private DbCodesCachingUtil dbCodesCachingUtil;

    @Autowired
    private OfferMasterRepository offerMasterRepository;

    @Autowired
    private OfferDetailsRepository offerDetailsRepository;

    @Autowired
    private AgentInfoEntityRepository agentInfoEntityRepository;

    @Autowired
    private TravelService travelService;

    @Autowired
    private VoucherService voucherService;
    private static final String LOCKED = "LOCKED";
    private static final String OPEN = "OPEN";
    private static final int ONE_MINUTE = 60 * 1000;
    private static final String NON_REVENUE_PAX_STRING = "NON REV";
    private static final String STAND_BY_PAX_STRING = "STAND BY";
    private static final String APASS_PAX_STRING = "APASS";
    private static final String MECHANICAL = "mechanical";
    private static final String ADULT = "ADULT";
    private static final String MINOR = "MINOR";
    private static final String NEW_ISSUANCE = "NEWISSUSANCE";
    private static final String AUTOMATED_DIGITAL_MEAL_VOUCHER = "Automated Digital Meal Voucher";
    private static final String OFFER_TYPE = "M";
    private static final String AGENT_FIRST_NAME = "HMT";
    private static final String AGENT_LAST_NAME = "AUTOMATION";
    private static final String AGENT_STATION = "HQD";
    private static final String TRUE_STRING = "true";

    @Override
    public void processMealIssuance(HMTAutomationPnr hmtAutomationPnr) {
        log.info("TransactionId: {} ClassName: {} method: {} hmtAutomationPnr: {}", hmtAutomationPnr.getTransactionId(),
                this.getClass().getSimpleName(), "processMealIssuance", hmtAutomationPnr);
        boolean isLocked = Boolean.FALSE;
        HMTAVoucher hmtaVoucherVoucher = null;
        try {
            isLocked = acquireLock(hmtAutomationPnr.getRecLoc(), hmtAutomationPnr.getTransactionId());
            saveToDbBeforeTACall(hmtAutomationPnr);
            List<PassengerInfo> passengerInfoList = travelService.importPassengersToTravelAlliance(hmtAutomationPnr);
            updateOfferStatusAfterTACall(passengerInfoList, hmtAutomationPnr.getTransactionId());
            String voucherId = getVoucherId(passengerInfoList);



//            if(Objects.nonNull(voucherId)){
//                hmtaVoucherVoucher = voucherService.callVoucherService(voucherId, hmtAutomationPnr.getTransactionId());
//            }

// 04-07-2024

            if(StringUtils.isEmpty(voucherId)){
                throw new HMTAutomationException("400", "Voucher id is null or empty.");
            }

            HMTAVoucher hmtaVoucher = voucherService.callVoucherService(voucherId, hmtAutomationPnr.getTransactionId());





            // TODO
        } finally {
            if(isLocked)
                releaseLock(hmtAutomationPnr.getRecLoc(), hmtAutomationPnr.getTransactionId());
        }
    }

    private void saveToDbBeforeTACall(HMTAutomationPnr hmtAutomationPnr) {
        log.info("TransactionId: {} ClassName: {} method: {} hmtAutomationPnr: {}", hmtAutomationPnr.getTransactionId(),
                this.getClass().getSimpleName(), "mealIssuanceEntry", hmtAutomationPnr);
        TimeZone.setDefault(TimeZone.getTimeZone(ApplicationConstants.INSTANCE.GMT_TZ));
        Timestamp createdDate = new Timestamp(Long.parseLong(hmtAutomationPnr.getPaxList().getFirst().getCredt()));
        pnrEntry(hmtAutomationPnr, createdDate);
        segmentEntry(hmtAutomationPnr, createdDate);
        TimeZone.setDefault(TimeZone.getTimeZone("UTC"));
        Timestamp timestamp = Timestamp.from(ZonedDateTime.now(ZoneOffset.UTC).toInstant());

        hmtAutomationPnr.getPaxList().forEach(pax -> {
            paxEntry(hmtAutomationPnr, pax, createdDate);
            //TODO for contact Entry
            fqtvEntry(hmtAutomationPnr, pax, createdDate);
            ssrEntry(hmtAutomationPnr, pax, createdDate);
            OfferMaster offerMaster = offerMasterEntry(hmtAutomationPnr, createdDate, hmtAutomationPnr.getCurrentSegment());
            offerDetailsEntry(hmtAutomationPnr, pax, timestamp, offerMaster, createdDate);
            agentInfoEntry(offerMaster, hmtAutomationPnr.getTransactionId());
        });
    }

    private void pnrEntry(HMTAutomationPnr hmtAutomationPnr, Timestamp createdDate) {
        log.info("TransactionId: {} ClassName: {} method: {} hmtAutomationPnr: {}", hmtAutomationPnr.getTransactionId(),
                this.getClass().getSimpleName(), "pnrEntry", hmtAutomationPnr);
        PnrTableKeyEntity pnrTableKeyEntity = new PnrTableKeyEntity();
        pnrTableKeyEntity.setRecloc(hmtAutomationPnr.getRecLoc());
        pnrTableKeyEntity.setCredt(createdDate);
        pnrTableKeyEntity.setVersion(hmtAutomationPnr.getVersion().toString());
        PnrTable pnrTable = new PnrTable();
        pnrTable.setId(pnrTableKeyEntity);
        pnrTable.setEliteStatus(String.valueOf(hmtAutomationPnr.getPaxList().stream().anyMatch(pax ->
                Objects.nonNull(pax.getIsElite()) && pax.getIsElite())));

        pnrTableRepository.saveAndFlush(pnrTable);
    }

    private boolean acquireLock(String recloc, String transactionId) {
        Date dateNow = new Date();
        PNRLockEntity pnrLockEntity = pnrLockEntityRepository.findById(recloc).orElse(new PNRLockEntity());
        log.info("TransactionId: {} ClassName: {} method: {} pnrLockEntity: {}", transactionId,
                this.getClass().getSimpleName(), "acquireLock", pnrLockEntity);
        if (LOCKED.equals(pnrLockEntity.getStatus()) && (dateNow.getTime() - pnrLockEntity.getLockedTime().getTime() < ONE_MINUTE)) {
            throw new HMTAutomationException("400", "This PNR locked for another meal issuance. Please retry after some time.");
        }

        pnrLockEntity.setRecloc(recloc);
        pnrLockEntity.setLockedTime(dateNow);
        pnrLockEntity.setLastUpdatedTime(dateNow);
        pnrLockEntity.setStatus(LOCKED);
        pnrLockEntityRepository.saveAndFlush(pnrLockEntity);
        return Boolean.TRUE;
    }

    private void releaseLock(String recloc, String transactionId) {
        PNRLockEntity pnrLockEntity = pnrLockEntityRepository.findById(recloc).orElse(null);
        log.info("TransactionId: {} ClassName: {} method: {} pnrLockEntity: {}", transactionId,
                this.getClass().getSimpleName(), "releaseLock", pnrLockEntity);
        if (Objects.nonNull(pnrLockEntity) && LOCKED.equals(pnrLockEntity.getStatus())) {
            pnrLockEntity.setLastUpdatedTime(new Date());
            pnrLockEntity.setStatus(OPEN);
            pnrLockEntityRepository.saveAndFlush(pnrLockEntity);
        }
    }

    private void segmentEntry(HMTAutomationPnr hmtAutomationPnr, Timestamp createdDate) {
        log.info("TransactionId: {} ClassName: {} method: {} hmtAutomationPnr: {}", hmtAutomationPnr.getTransactionId(),
                this.getClass().getSimpleName(), "segmentEntry", hmtAutomationPnr);
        PnrSegKeyEntity pnrSegKeyEntity = new PnrSegKeyEntity();
        pnrSegKeyEntity.setRecloc(hmtAutomationPnr.getRecLoc());
        pnrSegKeyEntity.setSegSeqId(hmtAutomationPnr.getCurrentSegment().getSeqNbr());
        pnrSegKeyEntity.setVersion(hmtAutomationPnr.getVersion().toString());
        pnrSegKeyEntity.setCredt(createdDate);

        PnrSegEntity pnrSegEntity = preparePnrSegEntity(hmtAutomationPnr.getCurrentSegment(),
                hmtAutomationPnr.getFlightKey().getDepSta(), pnrSegKeyEntity, hmtAutomationPnr.getTransactionId());

        pnrSegEntityRepository.saveAndFlush(pnrSegEntity);
    }

    private PnrSegEntity preparePnrSegEntity(CurrentSegment currentSegment, String depStation, PnrSegKeyEntity
            pnrSegKeyEntity, String transactionId) {
        log.info("TransactionId: {} ClassName: {} method: {} pnrSegKeyEntity: {}", transactionId,
                this.getClass().getSimpleName(), "preparePnrSegEntity", pnrSegKeyEntity);
        PnrSegEntity pnrSegments = new PnrSegEntity();
        pnrSegments.setId(pnrSegKeyEntity);
        pnrSegments.setOpCrirCd(currentSegment.getOprCd());
        pnrSegments.setOpFltNmbr(currentSegment.getOprFltNbr());
        pnrSegments.setMktCrirCd(currentSegment.getMktCode());
        pnrSegments.setMktFltNmbr(currentSegment.getMktFltNbr());
        pnrSegments.setSegBgnStn(depStation);
        pnrSegments.setSegEndStn(currentSegment.getArrStation());
        pnrSegments.setSegStatusCd(currentSegment.getStatus());
        pnrSegments.setCurrSeg(Boolean.TRUE.toString().toUpperCase());
        return pnrSegments;
    }

    private void paxEntry(HMTAutomationPnr hmtAutomationPnr, Pax pax, Timestamp createdDate) {
        log.info("TransactionId: {} ClassName: {} method: {} hmtAutomationPnr: {}", hmtAutomationPnr.getTransactionId(),
                this.getClass().getSimpleName(), "paxEntry", hmtAutomationPnr);
        PnrPaxKeyEntity pnrPaxKeyEntity = new PnrPaxKeyEntity();
        pnrPaxKeyEntity.setPaxSeq(pax.getSeqNbr().toString());
        pnrPaxKeyEntity.setRecloc(hmtAutomationPnr.getRecLoc());
        pnrPaxKeyEntity.setCredt(createdDate);
        pnrPaxKeyEntity.setVersion(hmtAutomationPnr.getVersion().toString());

        PnrPaxEntity pnrPaxEntity = new PnrPaxEntity();
        pnrPaxEntity.setId(pnrPaxKeyEntity);
        pnrPaxEntity.setFirstName(pax.getFirstName());
        pnrPaxEntity.setLastName(pax.getLastName());
        pnrPaxEntity.setPaxStatus(getPaxStatus(pax.getIsNonRev(), pax.getIsStandBy(), hmtAutomationPnr.getIsAPass(),
                hmtAutomationPnr.getTransactionId()));
        pnrPaxEntity.setAdvantageNumber(pax.getAdvantageNumber());

        pnrPaxEntityRepository.saveAndFlush(pnrPaxEntity);
    }

    private String getPaxStatus(Boolean isNonRev, Boolean isStandBy, boolean isAPass, String transactionId) {
        log.info("TransactionId: {} ClassName: {} method: {} isNonRev: {} isStandBy: {}", transactionId,
                this.getClass().getSimpleName(), "getPaxStatus", isNonRev, isStandBy);
        if (Objects.nonNull(isNonRev) && isNonRev) {
            return NON_REVENUE_PAX_STRING;
        }
        if (Objects.nonNull(isStandBy) && isStandBy) {
            return STAND_BY_PAX_STRING;
        }
        if (isAPass) {
            return APASS_PAX_STRING;
        }
        return null;
    }

    private void fqtvEntry(HMTAutomationPnr hmtAutomationPnr, Pax pax, Timestamp createdDate) {
        log.info("TransactionId: {} ClassName: {} method: {} hmtAutomationPnr: {}", hmtAutomationPnr.getTransactionId(),
                this.getClass().getSimpleName(), "fqtvEntry", hmtAutomationPnr);
        PnrFqtvKeyEntity pnrFqtvKeyEntity = new PnrFqtvKeyEntity();
        pnrFqtvKeyEntity.setPaxSeq(pax.getSeqNbr().toString());
        pnrFqtvKeyEntity.setRecloc(hmtAutomationPnr.getRecLoc());
        pnrFqtvKeyEntity.setCredt(createdDate);
        pnrFqtvKeyEntity.setVersion(hmtAutomationPnr.getVersion().toString());

        PnrFqtvEntity pnrFqtvEntity = new PnrFqtvEntity();
        pnrFqtvEntity.setId(pnrFqtvKeyEntity);
        pnrFqtvEntity.setAirlnCd("");
        pnrFqtvEntity.setFqtvNmbr(pax.getAdvantageNumber());
        pnrFqtvEntity.setClassOfService(getClassOfService(pax.getClassOfService(), hmtAutomationPnr.getTransactionId()));
        pnrFqtvEntity.setTierStatus(pax.getTierStatus());

        pnrFqtvEntityRepository.saveAndFlush(pnrFqtvEntity);
    }

    private void ssrEntry(HMTAutomationPnr hmtAutomationPnr, Pax pax, Timestamp createdDate) {
        log.info("TransactionId: {} ClassName: {} method: {} hmtAutomationPnr: {}", hmtAutomationPnr.getTransactionId(),
                this.getClass().getSimpleName(), "ssrEntry", hmtAutomationPnr);
        if (Objects.nonNull(pax.getsSRcodes()) && !pax.getsSRcodes().isEmpty()) {
            AtomicInteger ssrId = new AtomicInteger(BigInteger.ONE.intValue());
            pax.getsSRcodes().forEach(ssrCode -> {
                PnrSsrKeyEntity pnrSsrKeyEntity = new PnrSsrKeyEntity();
                pnrSsrKeyEntity.setPaxSeq(pax.getSeqNbr().toString());
                pnrSsrKeyEntity.setRecloc(hmtAutomationPnr.getRecLoc());
                pnrSsrKeyEntity.setCredt(createdDate);
                pnrSsrKeyEntity.setVersion(hmtAutomationPnr.getVersion().toString());
                pnrSsrKeyEntity.setSsrId(ssrId.getAndIncrement());

                PnrSsrEntity pnrSsrEntity = new PnrSsrEntity();
                pnrSsrEntity.setId(pnrSsrKeyEntity);
                pnrSsrEntity.setSsrCode(ssrCode);
                pnrSsrEntity.setSsrDesc(dbCodesCachingUtil.getSsrCodeMappings(ssrCode).getSsrCodeDescription());

                pnrSsrEntityRepository.saveAndFlush(pnrSsrEntity);
            });
        }
    }

    private String getClassOfService(String classOfServiceCode, String transactionId) {
        log.info("TransactionId: {} ClassName: {} method: {} classOfServiceCode: {}", transactionId,
                this.getClass().getSimpleName(), "getClassOfService", classOfServiceCode);
        Optional<ClassOfServiceMappings> classOfServiceMappings = dbCodesCachingUtil.getClassOfServiceMappings(classOfServiceCode);
        return classOfServiceMappings.map(ClassOfServiceMappings::getClassOfService).orElse(null);
    }

    private OfferMaster offerMasterEntry(HMTAutomationPnr hmtAutomationPnr, Timestamp createdDate, CurrentSegment currentSegment) {
        log.info("TransactionId: {} ClassName: {} method: {} hmtAutomationPnr: {}", hmtAutomationPnr.getTransactionId(),
                this.getClass().getSimpleName(), "offerMasterEntry", hmtAutomationPnr);
        TimeZone.setDefault(TimeZone.getTimeZone("UTC"));
        Timestamp timestamp = Timestamp.from(ZonedDateTime.now(ZoneOffset.UTC).toInstant());
        OfferMaster offerMaster = new OfferMaster();
        offerMaster.setRecLoc(hmtAutomationPnr.getRecLoc());
        offerMaster.setCredt(createdDate);
        offerMaster.setVersion(hmtAutomationPnr.getVersion().toString());
        offerMaster.setOfferCreatedTime(timestamp);
        offerMaster.setLastUpdatedTime(timestamp);
        offerMaster.setDsrtFltStatus(hmtAutomationPnr.getDsrtFltStatus());
        offerMaster.setDisFltDepDate(currentSegment.getDepDate() + " " + ApplicationUtils.
                stringTimeToLocalTimeConverter(currentSegment.getDepTime(), ApplicationConstants.INSTANCE.TIME_FORMATER_HHMM));
        offerMaster.setDisruptType(MECHANICAL);
        offerMaster.setFlightNumber(hmtAutomationPnr.getFlightKey().getFltNum());
        offerMaster.setDisFltOpAlCode(currentSegment.getOprCd());
        offerMaster.setDisFltDepStn(hmtAutomationPnr.getFlightKey().getDepSta());
        offerMaster.setDisFltArvStn(currentSegment.getArrStation());

        return offerMasterRepository.saveAndFlush(offerMaster);
    }

    private void offerDetailsEntry(HMTAutomationPnr hmtAutomationPnr, Pax pax, Timestamp timestamp,
                                   OfferMaster offerMaster, Timestamp createdDate) {
        log.info("TransactionId: {} ClassName: {} method: {} hmtAutomationPnr: {}", hmtAutomationPnr.getTransactionId(),
                this.getClass().getSimpleName(), "offerDetailsEntry", hmtAutomationPnr);
        String groupId = hmtAutomationPnr.getRecLoc() + timestamp.toInstant().getEpochSecond();
        OfferDetails offerDetails = new OfferDetails();
        offerDetails.setRecloc(hmtAutomationPnr.getRecLoc());
        offerDetails.setCredt(createdDate);
        offerDetails.setVersion(hmtAutomationPnr.getVersion().toString());
        offerDetails.setPaxSeq(pax.getSeqNbr().toString());
        offerDetails.setContextId(generateContextId(hmtAutomationPnr.getRecLoc(), createdDate, pax.getSeqNbr(),
                    hmtAutomationPnr.getVersion(), offerMaster.getOfferSeq(), hmtAutomationPnr.getTransactionId()));
        offerDetails.setOfferSeq(offerMaster.getOfferSeq());
        offerDetails.setSelftServe(Boolean.TRUE.toString());
        offerDetails.setMealOffer(Boolean.TRUE.toString());
        offerDetails.setReasonCode(AUTOMATED_DIGITAL_MEAL_VOUCHER);
        offerDetails.setCurrencyCode(hmtAutomationPnr.getCurrencyCode());
        offerDetails.setMealAmount(Double.parseDouble(hmtAutomationPnr.getMealAmount()));
        offerDetails.setNumberOfMeals(BigInteger.ONE.intValue());
        offerDetails.setOfferStatus(ApplicationConstants.INSTANCE.CREATED);
        offerDetails.setAaPay(Boolean.TRUE.toString());
        offerDetails.setFlightCode(hmtAutomationPnr.getFlifoCode());
        offerDetails.setNumberOfNights(BigInteger.ZERO.intValue());
        offerDetails.setPnrGroupId(groupId);
        offerDetails.setNotify(Boolean.FALSE.toString());
        if (pax.getIsMinor()) {
            offerDetails.setLifestage(MINOR);
        } else {
            offerDetails.setLifestage(ADULT);
        }
        offerDetails.setLastUpdTms(timestamp);
        offerDetails.setRequestType(NEW_ISSUANCE);
        offerDetails.setAgentEnumber(ApplicationConstants.INSTANCE.HMT_AUTOMATION_AGENT_ID);
        offerDetails.setIsEC261(pax.getIsEC261().toString());
        offerDetails.setCupid(pax.getCupId());
        offerDetails.setIssuanceTransactionId(hmtAutomationPnr.getTransactionId());

        offerDetailsRepository.saveAndFlush(offerDetails);
    }

    private String generateContextId(String recloc, Timestamp createdDate, Integer seqNbr, Integer version,
                                    long offerSeq, String transactionId) {
        log.info("TransactionId: {} ClassName: {} method: {} recloc: {}", transactionId,
                this.getClass().getSimpleName(), "generateContextId", recloc);
        return recloc + createdDate.getTime() + offerSeq + seqNbr + version.toString() + OFFER_TYPE;
    }

    private void agentInfoEntry(OfferMaster offerMaster, String transactionId) {
        log.info("TransactionId: {} ClassName: {} method: {} offerSeq: {}", transactionId,
                this.getClass().getSimpleName(), "agentInFoEntry", offerMaster.getOfferSeq());
        AgentInfoEntity agentInfoEntity = new AgentInfoEntity();
        agentInfoEntity.setOfferSeq(offerMaster.getOfferSeq());
        agentInfoEntity.setLastUpdatedTime(offerMaster.getLastUpdatedTime());
        agentInfoEntity.setAgentEnumber(ApplicationConstants.INSTANCE.HMT_AUTOMATION_AGENT_ID);
        agentInfoEntity.setAgentFirstName(AGENT_FIRST_NAME);
        agentInfoEntity.setAgentLastName(AGENT_LAST_NAME);
        agentInfoEntity.setAgentRole(Boolean.FALSE.toString());
        agentInfoEntity.setAgentStation(AGENT_STATION);

        agentInfoEntityRepository.saveAndFlush(agentInfoEntity);
    }

    private void updateOfferStatusAfterTACall(List<PassengerInfo> passengerInfoList, String transactionId) {
        log.info("TransactionId: {} ClassName: {} method: {} passengerInfoList: {}", transactionId,
                this.getClass().getSimpleName(), "updateOfferStatusAfterTACall", passengerInfoList);
            for(PassengerInfo passengerInfo : passengerInfoList) {
                OfferDetails offerDetails = offerDetailsRepository.findByContextId(passengerInfo.getContext_id());
                mappingTaCallResponseToOfferDetails(passengerInfo, offerDetails, transactionId);
        }
    }

    private void mappingTaCallResponseToOfferDetails(PassengerInfo passengerInfo, OfferDetails offerDetails, String transactionId) {
        log.info("TransactionId: {} ClassName: {} method: {} passengerInfo: {} offerDetails: {}", transactionId,
                this.getClass().getSimpleName(), "mappingTaCallResponseToOfferDetails", passengerInfo, offerDetails);

        if(Objects.nonNull(offerDetails)) {
            offerDetails.setAirlineId(passengerInfo.getAirline_id());

            if(StringUtils.isNotBlank(passengerInfo.getExpiration_date())) {
                offerDetails.setExpirationDate(passengerInfo.getExpiration_date());
            }

            if(StringUtils.isNotBlank(passengerInfo.getOffer_url())) {
                offerDetails.setOfferUrl(passengerInfo.getOffer_url());
            }

            if(StringUtils.isNotBlank(passengerInfo.getError_message())) {
                offerDetails.setErrorMessage(passengerInfo.getError_message());
            }

            if(StringUtils.isNotBlank(passengerInfo.getText_sent_date())) {
                offerDetails.setTextSentDate(passengerInfo.getText_sent_date());
            }

            if(StringUtils.isNotBlank(passengerInfo.getVoucher_id())) {
                offerDetails.setVoucherId(passengerInfo.getVoucher_id());
            }

            if(StringUtils.isNotBlank(passengerInfo.getPort_accommodation())) {
                offerDetails.setPortAccomodation(passengerInfo.getPort_accommodation());
            }

            if(StringUtils.isNotBlank(passengerInfo.getModified_date())) {
                offerDetails.setModifiedTime(ApplicationUtils.dateConverter(passengerInfo.
                        getModified_date(), passengerInfo.getModified_date().length() > 19 ? ApplicationConstants.
                        INSTANCE.DATE_FORMATER_YYYY_MM_DD_HH_MM_SS_SSS : ApplicationConstants.INSTANCE.DATE_FORMATER_YYYY_MM_DD_HH_MM_SS));
            }

            // TO DO
            if(StringUtils.isNotBlank(passengerInfo.getCreate_date())) {
                offerDetails.setCreatedTime(ApplicationUtils.stringToGmtDateConverter(passengerInfo.getCreate_date(),
                        ApplicationConstants.INSTANCE.DATE_FORMATER_YYYY_MM_DD_HH_MM_SS));
            }

            offerDetails.setOfferStatus(OfferStatusEnum.OFFERED.getValue());
            offerDetails = updatingMealAndOfferStatus(offerDetails);
            offerDetailsRepository.saveAndFlush(offerDetails);
        }
    }

    private OfferDetails updatingMealAndOfferStatus(OfferDetails offerDetails) {
        if(Objects.nonNull(offerDetails.getMealOffer()) && TRUE_STRING.equalsIgnoreCase(offerDetails.getMealOffer())
                && Objects.isNull(offerDetails.getHotelOffer())) {
            Instant instant = Instant.now();
            offerDetails.setIssueTimeGmt(Date.from(instant));
            offerDetails.setHotelStatus(OfferStatusEnum.NOT_OFFERED.getValue());
            offerDetails.setMealStatus(OfferStatusEnum.ACCEPTED.getValue());
            offerDetails.setOfferStatus(OfferStatusEnum.ACCEPTED.getValue());
        }
        return offerDetails;
    }

    private String getVoucherId(List<PassengerInfo> passengerInfoList) {
        Optional<String> voucherIdOptional = passengerInfoList.stream().filter(Objects::nonNull).map(PassengerInfo::getVoucher_id).findFirst();
        return voucherIdOptional.orElse(null);
    }

}


